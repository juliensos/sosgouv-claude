<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOS-GOUV - Proposer Gouvernement Classique</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .gov-info-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .gov-info-section input[type="text"],
        .gov-info-section textarea {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
        }

        .gov-info-section textarea {
            min-height: 100px;
            resize: vertical;
        }

        .positions-grid {
            display: grid;
            gap: 20px;
        }

        .position-card {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .position-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .position-info {
            flex: 1;
        }

        .position-line {
            margin-bottom: 8px;
        }

        .label-text {
            display: inline-block;
            font-weight: bold;
            color: #667eea;
            min-width: 100px;
        }

        .value-text {
            display: inline;
            color: #333;
        }

        .custom-input {
            display: inline-block;
            padding: 5px 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            min-width: 300px;
        }

        .custom-input[readonly] {
            background: #f8f9fa;
            border-color: #e0e0e0;
        }

        .edit-btn {
            background: #ffa500;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .edit-btn:hover {
            background: #ff8c00;
        }

        .personality-section {
            margin-top: 15px;
        }

        .personality-search {
            position: relative;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .personality-search input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .personality-select {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            background: white;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .autocomplete-results.show {
            display: block;
        }

        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-item:hover {
            background: #f8f9fa;
        }

        .add-personality-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        .add-personality-btn:hover {
            background: #218838;
        }

        .selected-personality {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }

        .selected-personality.show {
            display: block;
        }

        .subsectors {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .delegates-section {
            background: #f0f4ff;
            padding: 30px;
            border-radius: 10px;
            margin-top: 40px;
        }

        .delegate-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .delegate-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .add-delegate-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }

        .add-delegate-btn:hover {
            background: #138496;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            margin-top: 5px;
        }

        .submit-section {
            margin-top: 40px;
            text-align: center;
            padding-top: 30px;
            border-top: 3px solid #e0e0e0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .submit-btn, .draft-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .draft-btn {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .submit-btn:hover, .draft-btn:hover {
            transform: translateY(-2px);
        }

        .submit-btn:hover {
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
        }

        .draft-btn:hover {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.6);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .cancel-btn {
            background: #6c757d;
            color: white;
        }

        .cancel-btn:hover {
            background: #5a6268;
        }

        .save-btn {
            background: #28a745;
            color: white;
        }

        .save-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="position: absolute; top: 10px; right: 10px; background: #667eea; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; font-weight: bold;">
            v2.7
        </div>
        <button onclick="testMenus()" style="position: absolute; top: 45px; right: 10px; background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; border: none; cursor: pointer;">
            üîß Test Menus
        </button>
        <h1>üèõÔ∏è Proposer un Gouvernement Classique</h1>
        <p class="subtitle">Composez votre gouvernement id√©al avec les minist√®res traditionnels</p>

        <div class="gov-info-section">
            <div class="form-group">
                <label for="govName">üìù Nom du gouvernement :</label>
                <input type="text" id="govName" placeholder="Ex: Gouvernement de la R√©publique Exemplaire">
            </div>

            <div class="form-group">
                <label for="govComment">üí¨ Commentaire de l'auteur (votre vision) :</label>
                <textarea id="govComment" placeholder="Expliquez votre vision, vos choix, vos priorit√©s..."></textarea>
            </div>
        </div>

        <h2 class="section-title">üë• Ministres</h2>
        <div id="positionsContainer" class="positions-grid"></div>

        <div class="delegates-section">
            <h2 class="section-title">üéØ Ministres D√©l√©gu√©s</h2>
            <button class="add-delegate-btn" onclick="addDelegate()">
                ‚ûï Ajouter un ministre d√©l√©gu√©
            </button>
            <div id="delegatesContainer"></div>
        </div>

        <div class="submit-section">
            <button class="draft-btn" onclick="saveDraft()">üíæ Sauvegarder en brouillon</button>
            <button class="submit-btn" onclick="submitGovernment()">‚úÖ Publier le Gouvernement</button>
        </div>
    </div>

    <!-- Modal Ajout Personnalit√© -->
    <div id="addPersonalityModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Ajouter une Personnalit√©</h3>
            <div class="form-group">
                <label>Nom :</label>
                <input type="text" id="newPersonName">
            </div>
            <div class="form-group">
                <label>Pr√©nom :</label>
                <input type="text" id="newPersonFirstname">
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Annuler</button>
                <button class="save-btn" onclick="saveNewPersonality()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Structure compl√®te des 22 minist√®res
        const CLASSIC_POSITIONS = [
            {
                sector: 'Matignon',
                title: 'Premier ministre',
                subsectors: ['Coordination gouvernementale', 'Relations avec le Parlement', 'Services du Premier ministre']
            },
            {
                sector: 'Justice',
                title: 'Garde des Sceaux, ministre de la Justice',
                subsectors: ['Justice judiciaire', 'Justice administrative', 'Administration p√©nitentiaire', 'Aide aux victimes']
            },
            {
                sector: 'Int√©rieur',
                title: 'Ministre de l\'Int√©rieur',
                subsectors: ['S√©curit√©', 'Immigration', 'Collectivit√©s territoriales', 'Police nationale']
            },
            {
                sector: 'D√©fense',
                title: 'Ministre des Arm√©es',
                subsectors: ['Arm√©e de terre', 'Marine nationale', 'Arm√©e de l\'air et de l\'espace', 'Gendarmerie nationale']
            },
            {
                sector: 'Affaires √©trang√®res',
                title: 'Ministre de l\'Europe et des Affaires √©trang√®res',
                subsectors: ['Diplomatie', 'Coop√©ration internationale', 'Francophonie', 'Commerce ext√©rieur']
            },
            {
                sector: '√âconomie',
                title: 'Ministre de l\'√âconomie et des Finances',
                subsectors: ['Budget', 'Fiscalit√©', 'Politique √©conomique', 'Industrie']
            },
            {
                sector: '√âducation',
                title: 'Ministre de l\'√âducation nationale',
                subsectors: ['Enseignement primaire', 'Enseignement secondaire', 'Programmes scolaires', 'Vie scolaire']
            },
            {
                sector: 'Enseignement sup√©rieur',
                title: 'Ministre de l\'Enseignement sup√©rieur et de la Recherche',
                subsectors: ['Universit√©s', 'Recherche scientifique', 'Innovation', 'Vie √©tudiante']
            },
            {
                sector: 'Sant√©',
                title: 'Ministre de la Sant√©',
                subsectors: ['H√¥pitaux', 'Sant√© publique', 'Pr√©vention', 'Personnes √¢g√©es']
            },
            {
                sector: 'Solidarit√©s',
                title: 'Ministre des Solidarit√©s',
                subsectors: ['Handicap', 'Famille', 'Enfance', 'Protection sociale']
            },
            {
                sector: 'Travail',
                title: 'Ministre du Travail',
                subsectors: ['Emploi', 'Formation professionnelle', 'Relations sociales', 'Inspection du travail']
            },
            {
                sector: 'Agriculture',
                title: 'Ministre de l\'Agriculture et de la Souverainet√© alimentaire',
                subsectors: ['Agriculture', 'P√™che', 'Alimentation', 'For√™t']
            },
            {
                sector: 'Environnement',
                title: 'Ministre de la Transition √©cologique',
                subsectors: ['Biodiversit√©', 'Climat', 'Pollution', '√âconomie circulaire']
            },
            {
                sector: '√ânergie',
                title: 'Ministre de la Transition √©nerg√©tique',
                subsectors: ['√ânergies renouvelables', 'Nucl√©aire', 'Efficacit√© √©nerg√©tique', 'Mix √©nerg√©tique']
            },
            {
                sector: 'Am√©nagement du territoire',
                title: 'Ministre de la Coh√©sion des territoires',
                subsectors: ['Am√©nagement territorial', 'Politique de la ville', 'Ruralit√©', 'D√©centralisation']
            },
            {
                sector: 'Culture',
                title: 'Ministre de la Culture',
                subsectors: ['Patrimoine', 'Arts', 'M√©dias', 'Cin√©ma']
            },
            {
                sector: 'Sports',
                title: 'Ministre des Sports et des Jeux Olympiques',
                subsectors: ['Sport professionnel', 'Sport amateur', 'Grandes manifestations', 'Sport sant√©']
            },
            {
                sector: 'Logement',
                title: 'Ministre du Logement',
                subsectors: ['Habitat social', 'Urbanisme', 'Construction', 'R√©novation urbaine']
            },
            {
                sector: 'Transports',
                title: 'Ministre des Transports',
                subsectors: ['Transport ferroviaire', 'Transport routier', 'Transport a√©rien', 'Transport maritime']
            },
            {
                sector: 'Mer',
                title: 'Ministre de la Mer',
                subsectors: ['P√™che maritime', 'Ports', '√âconomie maritime', 'Littoral']
            },
            {
                sector: 'Outre-mer',
                title: 'Ministre des Outre-mer',
                subsectors: ['DOM-TOM', 'D√©veloppement ultramarin', 'Coop√©ration r√©gionale']
            },
            {
                sector: 'Fonction publique',
                title: 'Ministre de la Transformation et de la Fonction publiques',
                subsectors: ['Administration publique', 'Modernisation', 'Num√©rique', 'Simplification']
            }
        ];

        // Cr√©er une liste de tous les sous-secteurs
        const ALL_SUBSECTORS = [];
        CLASSIC_POSITIONS.forEach(pos => {
            pos.subsectors.forEach(sub => {
                ALL_SUBSECTORS.push({
                    sector: pos.sector,
                    subsector: sub
                });
            });
        });

        let personalities = [];
        let governmentData = {
            positions: []
        };
        let currentPositionIndex = null;

        // Charger les personnalit√©s
        async function loadPersonalities() {
            const { data, error } = await supabase
                .from('personalities')
                .select('*')
                .order('name');
            
            if (data) {
                personalities = data;
                console.log('Personnalit√©s charg√©es:', personalities.length);
            } else {
                console.error('Erreur chargement personnalit√©s:', error);
            }
        }

        // Peupler tous les selects de personnalit√©s group√©s par profession
        function populatePersonalitySelects() {
            console.log('=== DEBUT REMPLISSAGE SELECTS ===');
            console.log('Nombre de personnalit√©s:', personalities.length);
            
            if (personalities.length === 0) {
                console.error('‚ùå AUCUNE PERSONNALITE - Les selects resteront vides');
                alert('‚ö†Ô∏è Aucune personnalit√© dans la base de donn√©es. Ajoutez-en d\'abord !');
                return;
            }

            // Grouper les personnalit√©s par profession
            const groupedByProfession = {};
            personalities.forEach(p => {
                const profession = p.profession || 'Sans profession';
                if (!groupedByProfession[profession]) {
                    groupedByProfession[profession] = [];
                }
                groupedByProfession[profession].push(p);
            });

            console.log('Professions trouv√©es:', Object.keys(groupedByProfession));

            // Trier les professions
            const sortedProfessions = Object.keys(groupedByProfession).sort();

            // G√©n√©rer les options HTML
            let optionsHTML = '<option value="">-- S√©lectionner par profession --</option>';
            sortedProfessions.forEach(profession => {
                optionsHTML += `<optgroup label="${profession}">`;
                groupedByProfession[profession].forEach(p => {
                    optionsHTML += `<option value="${p.id}">${p.firstname} ${p.name}</option>`;
                });
                optionsHTML += '</optgroup>';
            });

            console.log('HTML g√©n√©r√©, longueur:', optionsHTML.length);

            // Appliquer aux selects des ministres
            let selectsRemplis = 0;
            let selectsNonTrouves = 0;
            
            CLASSIC_POSITIONS.forEach((pos, index) => {
                const select = document.getElementById(`select-${index}`);
                if (select) {
                    select.innerHTML = optionsHTML;
                    selectsRemplis++;
                } else {
                    selectsNonTrouves++;
                    console.error(`‚ùå Select non trouv√© pour index ${index}`);
                }
            });
            
            console.log(`‚úÖ ${selectsRemplis} selects remplis`);
            console.log(`‚ùå ${selectsNonTrouves} selects non trouv√©s`);
            console.log('=== FIN REMPLISSAGE SELECTS ===');
        }

        // Initialisation
        async function init() {
            await loadPersonalities();
            renderPositions();
            // Attendre que le DOM soit pr√™t puis remplir les selects
            setTimeout(() => {
                populatePersonalitySelects();
            }, 200);
        }

        // G√©n√©rer les cartes de postes
        function renderPositions() {
            const container = document.getElementById('positionsContainer');
            container.innerHTML = '';

            CLASSIC_POSITIONS.forEach((pos, index) => {
                const card = document.createElement('div');
                card.className = 'position-card';
                card.innerHTML = `
                    <div class="position-header">
                        <div class="position-info">
                            <div class="position-line">
                                <span class="label-text">Secteur :</span>
                                <span class="value-text">${pos.sector}</span>
                            </div>
                            <div class="position-line">
                                <span class="label-text">Fonction :</span>
                                <span class="value-text">${pos.title}</span>
                            </div>
                            <div class="position-line">
                                <span class="label-text">Intitul√© :</span>
                                <input type="text" 
                                       class="custom-input" 
                                       id="custom-${index}" 
                                       placeholder="ex: en charge de la gestion des pand√©mies"
                                       readonly>
                            </div>
                        </div>
                        <button class="edit-btn" onclick="toggleEdit(${index})">‚úèÔ∏è Modifier</button>
                    </div>

                    <div class="subsectors">
                        <strong>Sous-secteurs :</strong> ${pos.subsectors.join(', ')}
                    </div>

                    <div class="personality-section">
                        <div class="personality-search">
                            <div class="search-input-wrapper">
                                <input type="text" 
                                       id="search-${index}" 
                                       placeholder="üîç Rechercher une personnalit√©..."
                                       oninput="searchPersonality(${index})"
                                       onfocus="searchPersonality(${index})">
                                <div class="autocomplete-results" id="results-${index}"></div>
                            </div>
                            <select class="personality-select" id="select-${index}" onchange="selectFromDropdown(${index}); return false;">
                                <option value="">-- S√©lectionner par profession --</option>
                            </select>
                        </div>
                        <button class="add-personality-btn" onclick="openAddPersonalityModal(${index})">
                            ‚ûï Ajouter une nouvelle personnalit√©
                        </button>
                        <div class="selected-personality" id="selected-${index}"></div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Activer/d√©sactiver l'√©dition de l'intitul√©
        function toggleEdit(index) {
            const input = document.getElementById(`custom-${index}`);
            input.readOnly = !input.readOnly;
            if (!input.readOnly) {
                input.focus();
                input.style.background = 'white';
                input.style.borderColor = '#667eea';
            } else {
                input.style.background = '#f8f9fa';
                input.style.borderColor = '#e0e0e0';
            }
        }

        // Recherche de personnalit√© avec autocomplete
        function searchPersonality(index) {
            const searchInput = document.getElementById(`search-${index}`);
            const resultsDiv = document.getElementById(`results-${index}`);
            const query = searchInput.value.toLowerCase();

            if (query.length < 1) {
                resultsDiv.classList.remove('show');
                return;
            }

            // Chercher uniquement au D√âBUT des noms et pr√©noms
            const filtered = personalities.filter(p => 
                p.name.toLowerCase().startsWith(query) || 
                p.firstname.toLowerCase().startsWith(query)
            );

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: #999;">Aucune personnalit√© trouv√©e</div>';
            } else {
                resultsDiv.innerHTML = filtered.map(p => `
                    <div class="autocomplete-item" onclick="selectPersonality(${index}, '${p.id}')">
                        <strong>${p.firstname} ${p.name}</strong>${p.profession ? ' - ' + p.profession : ''}
                    </div>
                `).join('');
            }

            resultsDiv.classList.add('show');
        }

        // S√©lectionner une personnalit√©
        function selectPersonality(index, personalityId) {
            console.log('=== SELECT PERSONALITY ===');
            console.log('Index:', index, 'PersonalityId:', personalityId, 'Type:', typeof personalityId);
            
            const personality = personalities.find(p => String(p.id) === String(personalityId));
            
            if (!personality) {
                console.error('‚ùå Personnalit√© non trouv√©e avec id:', personalityId);
                console.log('IDs disponibles:', personalities.map(p => p.id));
                alert('Erreur : personnalit√© non trouv√©e');
                return;
            }
            
            console.log('‚úÖ Personnalit√© trouv√©e:', personality.firstname, personality.name);
            
            const searchInput = document.getElementById(`search-${index}`);
            const resultsDiv = document.getElementById(`results-${index}`);
            const selectedDiv = document.getElementById(`selected-${index}`);
            const selectElement = document.getElementById(`select-${index}`);

            if (searchInput) searchInput.value = `${personality.firstname} ${personality.name}`;
            if (resultsDiv) resultsDiv.classList.remove('show');
            
            // Synchroniser le select
            if (selectElement) {
                selectElement.value = personalityId;
            }
            
            if (selectedDiv) {
                selectedDiv.innerHTML = `
                    <strong>‚úÖ S√©lectionn√© :</strong> ${personality.firstname} ${personality.name}
                `;
                selectedDiv.classList.add('show');
            }

            if (!governmentData.positions[index]) {
                governmentData.positions[index] = {};
            }
            governmentData.positions[index].personalityId = personalityId;
            
            console.log('‚úÖ Personnalit√© enregistr√©e dans governmentData position', index);
        }

        // Ouvrir modal ajout personnalit√©
        function openAddPersonalityModal(index) {
            currentPositionIndex = index;
            document.getElementById('addPersonalityModal').classList.add('show');
        }

        // Fermer modal
        function closeModal() {
            document.getElementById('addPersonalityModal').classList.remove('show');
            document.getElementById('newPersonName').value = '';
            document.getElementById('newPersonFirstname').value = '';
        }

        // Sauvegarder nouvelle personnalit√©
        async function saveNewPersonality() {
            const name = document.getElementById('newPersonName').value;
            const firstname = document.getElementById('newPersonFirstname').value;

            if (!name || !firstname) {
                alert('Nom et pr√©nom sont obligatoires');
                return;
            }

            const { data, error } = await supabase
                .from('personalities')
                .insert([{ name, firstname, status: 'neant' }])
                .select();

            if (error) {
                alert('Erreur lors de l\'ajout : ' + error.message);
                return;
            }

            personalities.push(data[0]);
            closeModal(); // Fermer AVANT de s√©lectionner
            selectPersonality(currentPositionIndex, data[0].id);
            populatePersonalitySelects(); // Repeupler les selects
            alert('‚úÖ Personnalit√© ajout√©e avec succ√®s !');
        }

        // Ajouter un ministre d√©l√©gu√©
        function addDelegate() {
            const delegatesContainer = document.getElementById('delegatesContainer');
            const delegateId = Date.now();

            // Cr√©er les options du menu d√©roulant avec TOUS les sous-secteurs
            const subsectorsOptions = ALL_SUBSECTORS.map(item => 
                `<option value="${item.sector}|${item.subsector}">${item.sector} - ${item.subsector}</option>`
            ).join('');

            // Cr√©er les options des personnalit√©s group√©es par profession
            const groupedByProfession = {};
            personalities.forEach(p => {
                const profession = p.profession || 'Sans profession';
                if (!groupedByProfession[profession]) {
                    groupedByProfession[profession] = [];
                }
                groupedByProfession[profession].push(p);
            });

            const sortedProfessions = Object.keys(groupedByProfession).sort();
            let personalityOptionsHTML = '<option value="">-- S√©lectionner par profession --</option>';
            sortedProfessions.forEach(profession => {
                personalityOptionsHTML += `<optgroup label="${profession}">`;
                groupedByProfession[profession].forEach(p => {
                    personalityOptionsHTML += `<option value="${p.id}">${p.firstname} ${p.name}</option>`;
                });
                personalityOptionsHTML += '</optgroup>';
            });

            const delegateCard = document.createElement('div');
            delegateCard.className = 'delegate-card';
            delegateCard.id = `delegate-${delegateId}`;
            delegateCard.innerHTML = `
                <div class="delegate-header">
                    <strong>Ministre d√©l√©gu√©</strong>
                    <button class="remove-btn" onclick="removeDelegate(${delegateId})">‚ùå Retirer</button>
                </div>
                
                <div class="form-group">
                    <label>Rattachement (secteur - sous-secteur) :</label>
                    <select id="delegate-sector-${delegateId}">
                        <option value="">-- S√©lectionnez un secteur/sous-secteur --</option>
                        ${subsectorsOptions}
                    </select>
                </div>

                <div class="form-group">
                    <label>En charge de :</label>
                    <input type="text" id="delegate-title-${delegateId}" 
                           placeholder="Ex: la transition num√©rique">
                </div>

                <div class="form-group">
                    <label>Personnalit√© :</label>
                    <div class="personality-search">
                        <div class="search-input-wrapper">
                            <input type="text" 
                                   id="delegate-search-${delegateId}" 
                                   placeholder="üîç Rechercher une personnalit√©..."
                                   oninput="searchDelegatePersonality(${delegateId})"
                                   onfocus="searchDelegatePersonality(${delegateId})">
                            <div class="autocomplete-results" id="delegate-results-${delegateId}"></div>
                        </div>
                        <select class="personality-select" id="delegate-select-${delegateId}" onchange="selectDelegateFromDropdown('${delegateId}'); return false;">
                            ${personalityOptionsHTML}
                        </select>
                    </div>
                    <div class="selected-personality" id="delegate-selected-${delegateId}"></div>
                </div>
            `;
            delegatesContainer.appendChild(delegateCard);
        }

        // Retirer un ministre d√©l√©gu√©
        function removeDelegate(delegateId) {
            document.getElementById(`delegate-${delegateId}`).remove();
        }

        // Recherche personnalit√© pour d√©l√©gu√©
        function searchDelegatePersonality(delegateId) {
            const searchInput = document.getElementById(`delegate-search-${delegateId}`);
            const resultsDiv = document.getElementById(`delegate-results-${delegateId}`);
            const query = searchInput.value.toLowerCase();

            if (query.length < 1) {
                resultsDiv.classList.remove('show');
                return;
            }

            // Chercher uniquement au D√âBUT des noms et pr√©noms
            const filtered = personalities.filter(p => 
                p.name.toLowerCase().startsWith(query) || 
                p.firstname.toLowerCase().startsWith(query)
            );

            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: #999;">Aucune personnalit√© trouv√©e</div>';
            } else {
                resultsDiv.innerHTML = filtered.map(p => `
                    <div class="autocomplete-item" onclick="selectDelegatePersonality('${delegateId}', '${p.id}')">
                        <strong>${p.firstname} ${p.name}</strong>${p.profession ? ' - ' + p.profession : ''}
                    </div>
                `).join('');
            }

            resultsDiv.classList.add('show');
        }

        // S√©lectionner personnalit√© pour d√©l√©gu√©
        function selectDelegatePersonality(delegateId, personalityId) {
            console.log('=== SELECT DELEGATE PERSONALITY ===');
            console.log('DelegateId:', delegateId, 'PersonalityId:', personalityId);
            
            const personality = personalities.find(p => String(p.id) === String(personalityId));
            
            if (!personality) {
                console.error('‚ùå Personnalit√© non trouv√©e avec id:', personalityId);
                alert('Erreur : personnalit√© non trouv√©e');
                return;
            }
            
            console.log('‚úÖ Personnalit√© trouv√©e:', personality.firstname, personality.name);
            
            const searchInput = document.getElementById(`delegate-search-${delegateId}`);
            const resultsDiv = document.getElementById(`delegate-results-${delegateId}`);
            const selectedDiv = document.getElementById(`delegate-selected-${delegateId}`);
            const selectElement = document.getElementById(`delegate-select-${delegateId}`);

            if (searchInput) {
                searchInput.value = `${personality.firstname} ${personality.name}`;
                searchInput.dataset.personalityId = personalityId;
            }
            if (resultsDiv) resultsDiv.classList.remove('show');
            
            // Synchroniser le select
            if (selectElement) {
                selectElement.value = personalityId;
            }
            
            if (selectedDiv) {
                selectedDiv.innerHTML = `
                    <strong>‚úÖ S√©lectionn√© :</strong> ${personality.firstname} ${personality.name}
                `;
                selectedDiv.classList.add('show');
            }
            
            console.log('‚úÖ Personnalit√© enregistr√©e pour d√©l√©gu√©');
        }

        // S√©lection depuis le menu d√©roulant pour d√©l√©gu√©
        function selectDelegateFromDropdown(delegateId) {
            console.log('=== SELECT DELEGATE FROM DROPDOWN ===');
            console.log('DelegateId:', delegateId);
            
            const select = document.getElementById(`delegate-select-${delegateId}`);
            if (!select) {
                console.error('‚ùå Select d√©l√©gu√© non trouv√© pour id:', delegateId);
                return;
            }
            
            const personalityId = select.value;
            console.log('PersonalityId s√©lectionn√©:', personalityId);
            
            if (!personalityId) {
                console.log('Aucune personnalit√© s√©lectionn√©e (valeur vide)');
                return;
            }
            
            // Trouver la personnalit√©
            const personality = personalities.find(p => String(p.id) === String(personalityId));
            console.log('Personnalit√© trouv√©e:', personality);
            
            if (personality) {
                console.log('‚úÖ Appel de selectDelegatePersonality');
                selectDelegatePersonality(delegateId, personality.id);
            } else {
                console.error('‚ùå Personnalit√© NON trouv√©e avec id:', personalityId);
            }
        }

        // Sauvegarder en brouillon
        async function saveDraft() {
            const govName = document.getElementById('govName').value;
            const govComment = document.getElementById('govComment').value;

            if (!govName) {
                alert('Veuillez donner un nom au gouvernement');
                return;
            }

            // R√©cup√©rer toutes les donn√©es
            const positions = [];
            CLASSIC_POSITIONS.forEach((pos, index) => {
                const customTitle = document.getElementById(`custom-${index}`).value;
                const personalityId = governmentData.positions[index]?.personalityId;

                if (personalityId) {
                    positions.push({
                        sector: pos.sector,
                        title: pos.title,
                        customTitle: customTitle,
                        subsectors: pos.subsectors,
                        personalityId: personalityId
                    });
                }
            });

            // R√©cup√©rer les d√©l√©gu√©s
            const delegates = [];
            document.querySelectorAll('.delegate-card').forEach(card => {
                const delegateId = card.id.split('-')[1];
                const sectorSelect = document.getElementById(`delegate-sector-${delegateId}`);
                const sectorValue = sectorSelect?.value;
                const title = document.getElementById(`delegate-title-${delegateId}`)?.value;
                const searchInput = document.getElementById(`delegate-search-${delegateId}`);
                const personalityId = searchInput?.dataset.personalityId;

                if (sectorValue && title && personalityId) {
                    const [sector, subsector] = sectorValue.split('|');
                    delegates.push({ sector, subsector, title, personalityId });
                }
            });

            const governmentToSave = {
                name: govName,
                type: 'classique',
                status: 'brouillon',
                comment: govComment,
                positions: positions,
                delegates: delegates
            };

            console.log('Brouillon √† sauvegarder:', governmentToSave);

            alert('üíæ Brouillon sauvegard√© avec succ√®s !\n\n' +
                  `Nom: ${govName}\n` +
                  `Ministres: ${positions.length}\n` +
                  `D√©l√©gu√©s: ${delegates.length}\n\n` +
                  `Vous pourrez le modifier et le publier plus tard.`);
        }

        // Soumettre le gouvernement
        async function submitGovernment() {
            const govName = document.getElementById('govName').value;
            const govComment = document.getElementById('govComment').value;

            if (!govName) {
                alert('Veuillez donner un nom au gouvernement');
                return;
            }

            // R√©cup√©rer toutes les donn√©es
            const positions = [];
            CLASSIC_POSITIONS.forEach((pos, index) => {
                const customTitle = document.getElementById(`custom-${index}`).value;
                const personalityId = governmentData.positions[index]?.personalityId;

                if (personalityId) {
                    positions.push({
                        sector: pos.sector,
                        title: pos.title,
                        customTitle: customTitle,
                        subsectors: pos.subsectors,
                        personalityId: personalityId
                    });
                }
            });

            if (positions.length === 0) {
                alert('Veuillez s√©lectionner au moins un ministre');
                return;
            }

            // R√©cup√©rer les d√©l√©gu√©s
            const delegates = [];
            document.querySelectorAll('.delegate-card').forEach(card => {
                const delegateId = card.id.split('-')[1];
                const sectorSelect = document.getElementById(`delegate-sector-${delegateId}`);
                const sectorValue = sectorSelect?.value;
                const title = document.getElementById(`delegate-title-${delegateId}`)?.value;
                const searchInput = document.getElementById(`delegate-search-${delegateId}`);
                const personalityId = searchInput?.dataset.personalityId;

                if (sectorValue && title && personalityId) {
                    const [sector, subsector] = sectorValue.split('|');
                    delegates.push({ sector, subsector, title, personalityId });
                }
            });

            const governmentToSave = {
                name: govName,
                type: 'classique',
                comment: govComment,
                positions: positions,
                delegates: delegates
            };

            console.log('Gouvernement √† sauvegarder:', governmentToSave);

            alert('‚úÖ Gouvernement enregistr√© avec succ√®s !\n\n' +
                  `Nom: ${govName}\n` +
                  `Ministres: ${positions.length}\n` +
                  `D√©l√©gu√©s: ${delegates.length}`);
        }

        // Fermer autocomplete en cliquant ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.personality-search')) {
                document.querySelectorAll('.autocomplete-results').forEach(div => {
                    div.classList.remove('show');
                });
            }
        });

        // D√©marrer l'application
        init();
    </script>
</body>
</html>
