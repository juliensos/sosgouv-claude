<!DOCTYPE html>
<html data-wf-domain="sosgouv.webflow.io" data-wf-page="68f00317ba745372947ddeee" data-wf-site="68ecfda4d9b3270b98426ff5" data-wf-status="1" lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>SOSGOUV - Imaginez votre gouvernement</title>
  <meta content="SOSGOUV - Imaginez votre gouvernement" property="og:title"/>
  <meta content="SOSGOUV - Imaginez votre gouvernement" property="twitter:title"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="Webflow" name="generator"/>
  
  <!-- CSS -->
  <link href="css/sosgouv.webflow.shared.5a6a2a206.css" rel="stylesheet" type="text/css"/>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect"/>
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous"/>
  <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
  <script type="text/javascript">
    WebFont.load({
      google: {
        families: ["Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic"]
      }
    });
  </script>
  
  <!-- Webflow -->
  <script type="text/javascript">
    !function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);
  </script>
  
  <!-- CACHER LOGO WEBFLOW -->
  <style>
    a[href*="webflow"] { display: none !important; }
    img[src*="webflow"] { display: none !important; }
  </style>
  
  <link href="https://cdn.prod.website-files.com/img/favicon.ico" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://cdn.prod.website-files.com/img/webclip.png" rel="apple-touch-icon"/>
</head>

<body class="body">
  <div class="_w-site-container">
    
    <!-- HEADER -->
    <div class="w-layout-blockcontainer n-header w-container">
      <div class="bloc-logo">
        <div class="logo-b">
          <a href="#accueil" data-page="accueil" class="link-logo">sosgouv</a>
        </div>
        <div class="logo-baseline">
          <div class="text-block-59">Imaginez et publiez</div>
          <div class="text-block-59">votre gouvernement</div>
        </div>
      </div>
      
      <div class="esp"></div>
      
      <!-- MENU DROPDOWN -->
      <div data-hover="false" data-delay="0" class="dropdown-menu w-dropdown">
        <div class="dropdown-toogle w-dropdown-toggle">
          <div class="fontello-icon-menu">‚ò∞</div>
        </div>
        <nav class="dropdown-list-menu w-dropdown-list">
          
          <!-- Menu NON connect√© -->
          <div id="menuNotConnected" class="drop-bloc-compte">
            <a href="#connect-2" data-page="connect-2" class="_w-dropdown-link">Cr√©er un compte</a>
            <a href="#connect-1" data-page="connect-1" class="_w-dropdown-link">Se connecter</a>
          </div>
          
          <!-- Menu CONNECT√â -->
          <div id="menuConnected" class="drop-bloc-compte" style="display: none;">
            <!-- Info utilisateur connect√© -->
            <div style="padding: 10px; border-bottom: 1px solid #aca69a; margin-bottom: 10px;">
              <div style="color: #aca69a; font-size: 11px; margin-bottom: 5px;">Connect√© en tant que :</div>
              <div id="connectedUsername" style="color: #f5b800; font-weight: 700; font-size: 14px;">-</div>
            </div>
            
            <a href="#mon-espace" data-page="mon-espace" class="_w-dropdown-link">Mon espace</a>
            <a href="#reglages" data-page="reglages" class="_w-dropdown-link">R√©glages utilisateurs</a>
            <a href="#" onclick="handleLogout(); return false;" class="_w-dropdown-link">Me d√©connecter</a>
          </div>
          
          <div class="drop-bloc-compte">
            <a href="#faq" data-page="faq" class="_w-dropdown-link">FAQ</a>
            <a href="#apropos" data-page="apropos" class="_w-dropdown-link">A propos</a>
          </div>
        </nav>
      </div>
    </div>

    <!-- BODY - Zone de contenu dynamique -->
    <div class="w-layout-blockcontainer _w-body w-container">
      <!-- Le contenu sera charg√© ici par le router -->
    </div>

    <!-- FOOTER -->
    <div class="w-layout-blockcontainer n-footer w-container">
      <div class="admin-bloc _0">
        <div class="test-version">espace admin</div>
        <div class="test-version">V-7.1</div>
      </div>
      <div class="admin-bloc">
        <a href="#personnalites" data-page="personnalites">liste personnalit√©s</a>
        <a href="#membres" data-page="membres">liste membres</a>
      </div>
    </div>
    
  </div>

  <!-- Scripts -->
  <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=68ecfda4d9b3270b98426ff5" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/js/webflow.schunk.50d850aa4962b686.js" type="text/javascript"></script>
  <script src="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/js/webflow.schunk.0a46a3eef4d87fb7.js" type="text/javascript"></script>
  <script src="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/js/webflow.45db7ba0.f8aeaa00459718de.js" type="text/javascript"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Auth Menu Manager V-7 -->
  <script>
    // Gestion du menu dynamique selon connexion
    function updateMenu() {
      const userStr = localStorage.getItem('sosgouv_user');
      const menuNotConnected = document.getElementById('menuNotConnected');
      const menuConnected = document.getElementById('menuConnected');
      const usernameDisplay = document.getElementById('connectedUsername');
      
      if (userStr) {
        try {
          const user = JSON.parse(userStr);
          
          // Utilisateur connect√©
          menuNotConnected.style.display = 'none';
          menuConnected.style.display = 'block';
          
          // Afficher le nom d'utilisateur
          if (usernameDisplay) {
            usernameDisplay.textContent = user.username || user.email || 'Utilisateur';
          }
          
          console.log('‚úÖ Utilisateur connect√©:', user.username);
        } catch (e) {
          console.error('Erreur parsing user:', e);
          localStorage.removeItem('sosgouv_user');
          menuNotConnected.style.display = 'block';
          menuConnected.style.display = 'none';
        }
      } else {
        // Utilisateur non connect√©
        menuNotConnected.style.display = 'block';
        menuConnected.style.display = 'none';
        console.log('‚ùå Utilisateur non connect√©');
      }
    }
    
    // D√©connexion (V-7)
    window.handleLogout = async function() {
      console.log('üî¥ D√©connexion en cours...');
      
      // Supprimer le localStorage
      localStorage.removeItem('sosgouv_user');
      localStorage.removeItem('pending_username');
      
      // D√©connecter de Supabase (pour OAuth Google)
      if (typeof window.supabase !== 'undefined') {
        try {
          const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
          const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';
          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          await supabase.auth.signOut();
          console.log('‚úÖ Session Supabase d√©connect√©e');
        } catch (error) {
          console.error('Erreur d√©connexion Supabase:', error);
        }
      }
      
      // Mettre √† jour le menu
      updateMenu();
      
      // Rediriger vers accueil
      if (window.router) {
        window.router.navigateTo('accueil');
      }
      
      alert('‚úÖ D√©connexion r√©ussie !');
    };
    
    // Mettre √† jour le menu au chargement
    updateMenu();
    
    // Mettre √† jour le menu quand on change de page
    window.addEventListener('popstate', updateMenu);
    
    // V√©rifier p√©riodiquement si l'utilisateur s'est connect√©
    setInterval(updateMenu, 1000);
  </script>
  
  <!-- OAuth Handler Global (V-7.1) -->
  <script>
    // G√©rer l'authentification OAuth sur toutes les pages
    setTimeout(async function() {
      if (typeof window.supabase !== 'undefined') {
        const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        console.log('üîç [V-7.1] Initialisation OAuth listener...');
        
        // √âcouter les changements d'√©tat d'authentification
        supabase.auth.onAuthStateChange(async (event, session) => {
          console.log('üîî [V-7.1] Auth event:', event);
          
          if (event === 'SIGNED_IN' && session) {
            console.log('‚úÖ [V-7.1] SIGNED_IN d√©tect√© !');
            console.log('Email:', session.user.email);
            
            const user = session.user;
            const pendingUsername = localStorage.getItem('pending_username');
            
            console.log('üíæ Pending username:', pendingUsername);
            
            // R√©cup√©rer le profil (cr√©√© par le trigger)
            const { data: existing, error: selectError } = await supabase
              .from('profiles')
              .select('*')
              .eq('email', user.email)
              .single();
            
            if (selectError) {
              console.error('‚ùå Erreur r√©cup√©ration profil:', selectError);
              return;
            }
            
            if (existing) {
              console.log('‚úÖ Profil trouv√©:', existing);
              
              // Si on a un pending_username, c'est une CR√âATION
              if (pendingUsername) {
                console.log('üîÑ Mise √† jour du username de', existing.username, 'vers', pendingUsername);
                
                const { error: updateError } = await supabase
                  .from('profiles')
                  .update({ 
                    username: pendingUsername,
                    auth_method: 'google'
                  })
                  .eq('id', user.id);
                
                if (updateError) {
                  console.error('‚ùå ERREUR UPDATE:', updateError);
                  alert('Erreur : ' + updateError.message);
                  return;
                }
                
                console.log('‚úÖ Username mis √† jour !');
                
                // Stocker dans localStorage avec le BON username
                localStorage.setItem('sosgouv_user', JSON.stringify({
                  id: user.id,
                  username: pendingUsername,
                  email: user.email,
                  auth_method: 'google'
                }));
                
                localStorage.removeItem('pending_username');
                
                alert('‚úÖ Compte cr√©√© avec succ√®s !');
                
                // Nettoyer l'URL
                window.history.replaceState({}, '', window.location.pathname);
                
                // Rediriger
                if (window.router) {
                  setTimeout(() => {
                    window.router.navigateTo('accueil');
                  }, 1000);
                }
              } else {
                // C'est une CONNEXION (pas de pending_username)
                console.log('‚ÑπÔ∏è Connexion avec compte existant');
                
                localStorage.setItem('sosgouv_user', JSON.stringify(existing));
                
                alert('‚úÖ Connexion r√©ussie !');
                
                // Rediriger
                if (window.router) {
                  window.router.navigateTo('accueil');
                }
              }
            }
          }
        });
        
        console.log('‚úÖ [V-7.1] OAuth listener actif');
      }
    }, 500);
  </script>
  
  <!-- Router SOSGOUV -->
  <script src="router.js"></script>
</body>
</html>
