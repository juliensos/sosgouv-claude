<!-- ============================================ -->
<!-- SOS-GOUV - Page Gouvernements Publi√©s (VERSION FINALE) -->
<!-- Affiche la liste des gouvernements depuis Supabase -->
<!-- ============================================ -->

<style>
/* Fontello Icons */
@font-face {
  font-family: 'fontello';
  src: url('./fonts/fontello.woff2?98826985') format('woff2');
  font-weight: normal;
  font-style: normal;
}

[class^="icon-"]:before, [class*=" icon-"]:before {
  font-family: "fontello";
  font-style: normal;
  font-weight: normal;
  speak: never;
  display: inline-block;
  text-decoration: inherit;
  width: 1em;
  margin-right: .2em;
  text-align: center;
  font-variant: normal;
  text-transform: none;
  line-height: 1em;
  margin-left: .2em;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.icon-paper-plane:before { content: '\e800'; }
.icon-heart-empty:before { content: '\e808'; }
.icon-heart-filled:before { content: '\e803'; }
.icon-pin:before { content: '\e80a'; }
.icon-pin-outline:before { content: '\e80b'; }
.icon-user:before { content: '\e818'; }
.icon-eye:before { content: '\e84a'; }
.icon-plus:before { content: '\e823'; }
.icon-list:before { content: '\e84e'; }
.icon-cancel:before { content: '\e805'; }
.icon-search:before { content: '\e801'; }

/* Nowrap utility */
.nowrap {
  white-space: nowrap;
}

/* Style pour les selects natifs */
.filter-select {
  padding: 8px 30px 8px 12px;
  border: 1px solid var(--sos-grey-3, #ddd);
  border-radius: 5px;
  font-size: 12px;
  background: white;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 8px center;
  background-size: 14px;
}

.filter-select:hover {
  border-color: var(--sos-grey-2, #999);
}

.filter-select:focus {
  outline: none;
  border-color: var(--color, #667eea);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.filter-select option {
  background: white;
  padding: 8px;
}

/* Style pour le container des filtres */
._w-selecta {
  border: none !important;
}

/* Syst√®me de vote avec c≈ìurs */
.rating-hearts {
  display: flex;
  gap: 5px;
  flex-direction: row-reverse;
  justify-content: flex-end;
  font-size: 1.5em;
}

.rating-hearts input[type="radio"] {
  display: none;
}

.rating-hearts label {
  cursor: pointer;
  transition: all 0.2s;
}

.rating-hearts label i {
  color: #ddd;
}

.rating-hearts input[type="radio"]:checked ~ label i,
.rating-hearts label:hover i,
.rating-hearts label:hover ~ label i {
  color: #ff6b6b;
}

.infos {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Lien personnalit√© */
.personality-link {
  color: inherit;
  text-decoration: none;
  cursor: pointer;
}

.personality-link:hover {
  color: var(--sos-pink, #ff6b6b);
  text-decoration: underline;
}

/* Gov-bloc avec filet en tiret en bas */
.gov-bloc {
  border: none !important;
  border-bottom: 2px dashed #ddd !important;
  padding-bottom: 20px;
  margin-bottom: 20px;
}
</style>

<div class="page gouv-publi-s">
  <div class="div-govglobal">
    
    <!-- Menu boutons (LIENS CORRIG√âS) -->
    <div class="div-gov-menu">
      <a href="page-ajouter-gouvernement.html" class="_w-link-bloc-button w-inline-block">
        <div class="text-block-52"><i class="icon-plus"></i></div>
        <div>ajouter un gouvernement</div>
      </a>
      <a href="page-ajouter-perso.html" class="_w-link-bloc-button w-inline-block">
        <div class="text-block-52"><i class="icon-user"></i></div>
        <div>ajouter une personnalit√©</div>
      </a>
      <a href="#" data-page="personnalites" class="_w-link-bloc-button blanc w-inline-block">
        <div class="text-block-52"><i class="icon-list"></i></div>
        <div>Liste personnalit√©s</div>
      </a>
    </div>

    <!-- Titre -->
    <div class="title-bloc">
      <h3 class="heading-3-gov">Gouvernements publi√©s</h3>
    </div>

    <!-- Filtres (SELECTS NATIFS) -->
    <div class="_w-selecta">
      <!-- Select Type (sans label) -->
      <select id="filterType" class="filter-select" onchange="applyFilters()">
        <option value="all">Type : Tous</option>
        <option value="classique">Type : Classique</option>
        <option value="hybride">Type : Hybride</option>
      </select>

      <!-- Select Trier par (sans label) -->
      <select id="sortBy" class="filter-select" onchange="applyFilters()">
        <option value="recent">Trier par : Plus r√©cents</option>
        <option value="rating">Trier par : Mieux not√©s</option>
        <option value="votes">Trier par : Plus vot√©s</option>
      </select>

      <!-- Checkbox Pr√™t √† gouverner -->
      <div class="form-block-7 w-form">
        <form id="email-form-2" name="email-form-2" data-name="Email Form 2" method="get">
          <label class="w-checkbox _w-dropdown-copy-copy">
            <div class="w-checkbox-input w-checkbox-input--inputType-custom checkbox" id="filterPretCheckbox"></div>
            <input type="checkbox" id="filterPret" name="checkbox" data-name="Checkbox" style="opacity:0;position:absolute;z-index:-1" onchange="applyFilters()"/>
            <span class="checkbox-label-2 w-form-label" for="checkbox">Pr√™t √† gouverner</span>
          </label>
        </form>
      </div>
    </div>

    <!-- Container des gouvernements -->
    <div id="governmentsContainer">
      <div style="padding: 40px; text-align: center; color: var(--sos-grey-1);">
        <i class="icon-search" style="font-size: 24px;"></i> Chargement des gouvernements...
      </div>
    </div>

  </div>
</div>

<!-- Modal D√©tails (REFAIT AVEC LES CODES GRAPHIQUES DU BLOC GOV) -->
<div id="modalDetails" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto; padding: 20px;">
  <div style="max-width: 900px; margin: 40px auto; background: white; border-radius: 10px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
    <button onclick="closeModal()" style="position: absolute; top: 15px; right: 15px; background: var(--red); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 24px; font-weight: bold; display: flex; align-items: center; justify-content: center; z-index: 10000;">
      <i class="icon-cancel"></i>
    </button>
    <div id="modalContent" style="padding: 0;">
      <!-- Contenu g√©n√©r√© dynamiquement -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// Configuration Supabase
// ============================================
const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================
// Variables globales
// ============================================
let allGovernments = [];
let allPersonalities = [];
let currentFilters = {
  type: 'all',
  sort: 'recent',
  pret: false
};
let pinnedGovs = JSON.parse(localStorage.getItem('sosgouv_pinned') || '[]');
let userVotes = JSON.parse(localStorage.getItem('sosgouv_user_votes') || '{}');

// ============================================
// Initialisation
// ============================================
async function init() {
  console.log('üöÄ Initialisation de la page gouvernements...');
  await loadPersonalities();
  await loadGovernments();
  
  // G√©rer le checkbox visuellement
  const checkbox = document.getElementById('filterPret');
  const checkboxDiv = document.getElementById('filterPretCheckbox');
  checkbox.addEventListener('change', function() {
    if (this.checked) {
      checkboxDiv.classList.add('w--redirected-checked');
    } else {
      checkboxDiv.classList.remove('w--redirected-checked');
    }
  });
}

// ============================================
// Charger les personnalit√©s
// ============================================
async function loadPersonalities() {
  try {
    const { data, error } = await supabase
      .from('personalities')
      .select('*');
    
    if (error) throw error;
    
    allPersonalities = data || [];
    console.log(`‚úÖ ${allPersonalities.length} personnalit√©s charg√©es`);
  } catch (error) {
    console.error('‚ùå Erreur chargement personnalit√©s:', error);
    allPersonalities = [];
  }
}

// ============================================
// Charger les gouvernements (SANS DONN√âES DE TEST)
// ============================================
async function loadGovernments() {
  try {
    const { data: govData, error: govError } = await supabase
      .from('governments')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (govError) throw govError;
    
    // Si aucun gouvernement, on affiche juste un message
    if (!govData || govData.length === 0) {
      console.log('‚ÑπÔ∏è Aucun gouvernement trouv√©');
      allGovernments = [];
      applyFilters();
      return;
    }
    
    // Charger les positions pour chaque gouvernement
    for (let gov of govData) {
      const { data: positions, error: posError } = await supabase
        .from('government_positions')
        .select('*')
        .eq('government_id', gov.id);
      
      gov.positions = positions || [];
      
      // Charger le compte de votes depuis une table votes si elle existe
      const { data: votes, error: votesError } = await supabase
        .from('government_votes')
        .select('rating')
        .eq('government_id', gov.id);
      
      if (votes && votes.length > 0) {
        const total = votes.reduce((sum, v) => sum + v.rating, 0);
        gov.rating = total / votes.length;
        gov.votes_count = votes.length;
      } else {
        gov.rating = gov.rating || 0;
        gov.votes_count = 0;
      }
    }
    
    allGovernments = govData;
    console.log(`‚úÖ ${allGovernments.length} gouvernements charg√©s`);
    applyFilters();
    
  } catch (error) {
    console.error('‚ùå Erreur chargement gouvernements:', error);
    showError();
  }
}

// ============================================
// Appliquer les filtres
// ============================================
function applyFilters() {
  const filterType = document.getElementById('filterType').value;
  const filterPret = document.getElementById('filterPret').checked;
  const sortBy = document.getElementById('sortBy').value;
  
  let filtered = [...allGovernments];
  
  // Filtre par type
  if (filterType !== 'all') {
    filtered = filtered.filter(g => g.type === filterType);
  }
  
  // Filtre pr√™t √† gouverner
  if (filterPret) {
    filtered = filtered.filter(g => g.status === 'public');
  }
  
  // Tri
  filtered.sort((a, b) => {
    switch (sortBy) {
      case 'recent':
        return new Date(b.created_at) - new Date(a.created_at);
      case 'rating':
        return (b.rating || 0) - (a.rating || 0);
      case 'votes':
        return (b.votes_count || 0) - (a.votes_count || 0);
      default:
        return 0;
    }
  });
  
  renderGovernments(filtered);
}

// ============================================
// Afficher les gouvernements
// ============================================
function renderGovernments(governments) {
  const container = document.getElementById('governmentsContainer');
  
  if (governments.length === 0) {
    container.innerHTML = `
      <div style="padding: 60px 20px; text-align: center; color: var(--sos-grey-1);">
        <div style="font-size: 48px; margin-bottom: 20px;">üèõÔ∏è</div>
        <h3>Aucun gouvernement trouv√©</h3>
        <p>Soyez le premier √† cr√©er un gouvernement !</p>
        <a href="page-ajouter-gouvernement.html" style="display: inline-block; margin-top: 20px; background: var(--sos-yellow); color: #000; padding: 12px 24px; border-radius: 5px; text-decoration: none; font-weight: bold;">
          <i class="icon-plus"></i> Cr√©er un gouvernement
        </a>
      </div>
    `;
    return;
  }
  
  container.innerHTML = governments.map(gov => renderGovernmentCard(gov)).join('');
  
  // Restaurer les votes de l'utilisateur
  governments.forEach(gov => {
    if (userVotes[gov.id]) {
      const radio = document.getElementById(`vote-${gov.id}-${userVotes[gov.id]}`);
      if (radio) radio.checked = true;
    }
  });
}

// ============================================
// Rendu d'une carte gouvernement (C≈íURS + LIENS PERSONNALIT√âS)
// ============================================
function renderGovernmentCard(gov) {
  const isPinned = pinnedGovs.includes(gov.id);
  const date = new Date(gov.created_at).toLocaleDateString('fr-FR');
  
  // Statut et type (NOWRAP CORRIG√â)
  const statusBadge = gov.status === 'public' 
    ? '<div class="nowrap _w-courant _w-bold _w-vert">Pr√™t √† gouverner</div>'
    : '<div class="nowrap _w-courant _w-grey">En attente</div>';
  
  const typeClass = gov.type === 'classique' ? 'classique' : 
                   gov.type === 'hybride' ? 'fiche' : 'note-moy';
  
  // Membres (max 5) AVEC LIENS
  const positions = gov.positions || [];
  const displayPositions = positions.slice(0, 5);
  const hasMore = positions.length > 5;
  
  const membersHTML = displayPositions.map(pos => {
    const pers = allPersonalities.find(p => p.id === pos.personality_id);
    if (!pers) return '';
    
    return `
      <div class="_w-courant-div">
        <a href="page-personalit√©.html?id=${pers.id}" class="personality-link" onclick="event.stopPropagation();">
          <div class="_w-courant _w-bold">${pers.firstname} ${pers.name}</div>
        </a>
        <div class="div-block-214">
          <div class="_w-courant _w-grey">${pos.title}</div>
        </div>
      </div>
    `;
  }).join('');
  
  // Note moyenne (NOWRAP AJOUT√â)
  const rating = gov.rating || 0;
  const votesCount = gov.votes_count || 0;
  
  return `
    <div class="gov-bloc">
      <div class="bloc-gov-list">
        <!-- En-t√™te -->
        <div class="bloc-en-tete">
          <h4 class="heading-4">${gov.name}</h4>
          <div class="_w-courant-div">
            <div class="nowrap _w-courant _w-bold _w-pink">${rating.toFixed(1)} / 5</div>
            ${statusBadge}
          </div>
        </div>
        
        <!-- Description -->
        ${gov.comment ? `
          <div class="descript">
            <p class="paragraph-2">${gov.comment}</p>
          </div>
        ` : ''}
        
        <!-- Membres (max 5) -->
        <div class="membres">
          ${membersHTML}
          ${hasMore ? `<div class="_w-courant _w-grey" style="margin-top: 10px;"><i class="icon-user"></i> + ${positions.length - 5} autres membres...</div>` : ''}
        </div>
        
        <!-- Bouton D√©tail -->
        <div class="detail" onclick="showDetails('${gov.id}')">
          <div class="fontello-white"><i class="icon-eye"></i></div>
          <div class="mini-current mini-bold black">D√©tail</div>
        </div>
      </div>
      
      <!-- Infos et actions -->
      <div class="block-gov-infos">
        <div class="infos">
          <!-- C≈ìurs de vote EN HAUT -->
          <div class="_w-courant-div" onclick="event.stopPropagation();" style="order: -1;">
            <div class="rating-hearts" id="rating-${gov.id}" style="justify-content: flex-end; margin: 0;">
              <input type="radio" name="vote-${gov.id}" id="vote-${gov.id}-5" value="5" onchange="submitVote('${gov.id}', 5)">
              <label for="vote-${gov.id}-5"><i class="icon-heart-filled"></i></label>
              <input type="radio" name="vote-${gov.id}" id="vote-${gov.id}-4" value="4" onchange="submitVote('${gov.id}', 4)">
              <label for="vote-${gov.id}-4"><i class="icon-heart-filled"></i></label>
              <input type="radio" name="vote-${gov.id}" id="vote-${gov.id}-3" value="3" onchange="submitVote('${gov.id}', 3)">
              <label for="vote-${gov.id}-3"><i class="icon-heart-filled"></i></label>
              <input type="radio" name="vote-${gov.id}" id="vote-${gov.id}-2" value="2" onchange="submitVote('${gov.id}', 2)">
              <label for="vote-${gov.id}-2"><i class="icon-heart-filled"></i></label>
              <input type="radio" name="vote-${gov.id}" id="vote-${gov.id}-1" value="1" onchange="submitVote('${gov.id}', 1)">
              <label for="vote-${gov.id}-1"><i class="icon-heart-filled"></i></label>
            </div>
          </div>
          
          <!-- Nombre de votes (SANS C≈íUR) -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Nombre de votes</div>
            <div class="_w-courant _w-bold _w-pink">${votesCount}</div>
          </div>
          
          <!-- Type -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini">Type</div>
            <div class="mini-current ${typeClass}">${gov.type}</div>
          </div>
          
          <!-- Date et auteur -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Publi√© le ${date} par</div>
            <a href="#" class="_w-user"><i class="icon-user"></i> utilisateur</a>
          </div>
        </div>
        
        <!-- Actions (IC√îNES FONTELLO) -->
        <div class="send-et-pin">
          <div class="envoyer" onclick="shareByEmail('${gov.id}')">
            <div class="fontello-white"><i class="icon-paper-plane"></i></div>
            <div class="mini-current mini-bold">Envoyer</div>
          </div>
          <div class="envoyer" onclick="togglePin('${gov.id}')" style="background-color: ${isPinned ? 'var(--sos-green)' : '#000'};">
            <div class="fontello-white"><i class="${isPinned ? 'icon-pin' : 'icon-pin-outline'}"></i></div>
            <div class="mini-current mini-bold">${isPinned ? '√âpingl√©' : '√âpingler'}</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================
// Soumettre un vote
// ============================================
async function submitVote(govId, rating) {
  // Sauvegarder localement
  userVotes[govId] = rating;
  localStorage.setItem('sosgouv_user_votes', JSON.stringify(userVotes));
  
  // Envoyer √† Supabase
  try {
    const { data, error } = await supabase
      .from('government_votes')
      .insert({
        government_id: govId,
        rating: rating,
        user_id: 'anonymous' // √Ä remplacer par l'ID utilisateur r√©el si connect√©
      });
    
    if (error) console.error('Erreur vote:', error);
  } catch (e) {
    console.log('Table government_votes non trouv√©e, vote sauvegard√© localement uniquement');
  }
  
  // Recalculer la moyenne
  const gov = allGovernments.find(g => g.id === govId);
  if (gov) {
    const currentTotal = (gov.rating || 0) * (gov.votes_count || 0);
    gov.votes_count = (gov.votes_count || 0) + 1;
    gov.rating = (currentTotal + rating) / gov.votes_count;
    
    alert(`‚úÖ Vote enregistr√© !\nVous avez donn√© ${rating}/5 c≈ìurs`);
    applyFilters();
  }
}

// ============================================
// Afficher les d√©tails (MODAL AVEC CODES GOV BLOC)
// ============================================
function showDetails(govId) {
  const gov = allGovernments.find(g => g.id === govId);
  if (!gov) return;
  
  const positions = gov.positions || [];
  const date = new Date(gov.created_at).toLocaleDateString('fr-FR');
  const rating = gov.rating || 0;
  
  // Status badge
  const statusBadge = gov.status === 'public' 
    ? '<div class="nowrap _w-courant _w-bold _w-vert">Pr√™t √† gouverner</div>'
    : '<div class="nowrap _w-courant _w-grey">En attente</div>';
  
  // Type class
  const typeClass = gov.type === 'classique' ? 'classique' : 
                   gov.type === 'hybride' ? 'fiche' : 'note-moy';
  
  // Members list WITH LINKS
  const membersHTML = positions.map(pos => {
    const pers = allPersonalities.find(p => p.id === pos.personality_id);
    if (!pers) return '';
    
    return `
      <div class="_w-courant-div" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
        <a href="page-personalit√©.html?id=${pers.id}" class="personality-link">
          <div class="_w-courant _w-bold" style="font-size: 1.1em;">${pers.firstname} ${pers.name}</div>
        </a>
        <div class="div-block-214">
          <div class="_w-courant _w-grey">${pos.sector} - ${pos.title}</div>
          ${pos.subsectors && pos.subsectors.length > 0 ? `<div class="_w-courant _w-mini" style="margin-top: 5px;"><em>Sous-secteurs: ${pos.subsectors.join(', ')}</em></div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  // Modal content using gov-bloc structure
  document.getElementById('modalContent').innerHTML = `
    <div class="gov-bloc" style="border-radius: 10px; overflow: hidden; margin: 0;">
      <div class="bloc-gov-list" style="padding: 30px;">
        <!-- En-t√™te -->
        <div class="bloc-en-tete">
          <h4 class="heading-4">${gov.name}</h4>
          <div class="_w-courant-div">
            <div class="nowrap _w-courant _w-bold _w-pink">${rating.toFixed(1)} / 5</div>
            ${statusBadge}
          </div>
        </div>
        
        <!-- Description -->
        ${gov.comment ? `
          <div class="descript" style="background: #fff9e6; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid var(--sos-yellow);">
            <h3 style="margin: 0 0 10px 0; color: var(--color);">üí¨ Vision de l'auteur</h3>
            <p class="paragraph-2" style="margin: 0;">${gov.comment}</p>
          </div>
        ` : ''}
        
        <!-- Membres complets -->
        <div class="membres">
          <h3 style="margin: 20px 0 15px 0; color: var(--color); border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
            <i class="icon-user"></i> Composition du Gouvernement (${positions.length})
          </h3>
          ${membersHTML}
        </div>
      </div>
      
      <!-- Infos -->
      <div class="block-gov-infos">
        <div class="infos">
          <!-- Type -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini">Type</div>
            <div class="mini-current ${typeClass}">${gov.type}</div>
          </div>
          
          <!-- Date -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Publi√© le</div>
            <div class="_w-courant _w-bold">${date}</div>
          </div>
          
          <!-- Note et Votes -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Note moyenne</div>
            <div class="_w-courant _w-bold _w-pink">${rating.toFixed(1)} / 5</div>
          </div>
          
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Nombre de votes</div>
            <div class="_w-courant _w-bold _w-pink">${gov.votes_count || 0}</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('modalDetails').style.display = 'block';
}

function closeModal() {
  document.getElementById('modalDetails').style.display = 'none';
}

// ============================================
// √âpingler/D√©s√©pingler
// ============================================
function togglePin(govId) {
  const index = pinnedGovs.indexOf(govId);
  
  if (index > -1) {
    pinnedGovs.splice(index, 1);
    alert('üìå Gouvernement retir√© de vos √©pingl√©s');
  } else {
    pinnedGovs.push(govId);
    alert('‚úÖ Gouvernement √©pingl√© !');
  }
  
  localStorage.setItem('sosgouv_pinned', JSON.stringify(pinnedGovs));
  applyFilters();
}

// ============================================
// Partager par email
// ============================================
function shareByEmail(govId) {
  const gov = allGovernments.find(g => g.id === govId);
  if (!gov) return;
  
  const email = prompt('üìß Entrez l\'adresse email :');
  if (!email) return;
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('‚ùå Email invalide');
    return;
  }
  
  const subject = encodeURIComponent(`D√©couvrez "${gov.name}" sur SOS-GOUV`);
  const body = encodeURIComponent(
    `Bonjour,\n\nD√©couvrez ce gouvernement sur SOS-GOUV :\n\n` +
    `"${gov.name}"\n` +
    `${gov.comment ? `\n${gov.comment}\n` : ''}` +
    `\nCordialement`
  );
  
  window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
  alert('‚úÖ Email pr√©par√© !');
}

// ============================================
// Afficher une erreur
// ============================================
function showError() {
  document.getElementById('governmentsContainer').innerHTML = `
    <div style="padding: 40px; text-align: center;">
      <h3 style="color: var(--red); margin-bottom: 20px;"><i class="icon-cancel"></i> Erreur de chargement</h3>
      <p style="color: var(--sos-grey-1); margin-bottom: 20px;">
        Impossible de charger les gouvernements depuis Supabase
      </p>
      <button onclick="init()" style="background: var(--sos-yellow); color: #000; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold;">
        <i class="icon-search"></i> R√©essayer
      </button>
    </div>
  `;
}

// ============================================
// Fermer modal si clic en dehors
// ============================================
document.addEventListener('click', (e) => {
  if (e.target.id === 'modalDetails') {
    closeModal();
  }
});

// ============================================
// Lancer l'initialisation
// ============================================
init();
</script>