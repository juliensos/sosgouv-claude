<!-- Page de connexion V-2 - VOTRE design Webflow + Fonctions auth-complete-system -->

<div class="page compte">
  <!-- CONNEXION -->
  <div class="_w-connect-bloc">
    <h3>Me connecter</h3>
    <form id="loginForm" class="user-pass" onsubmit="return false;">
      <div class="_w-text-area">
        <input type="text" id="loginUsername" placeholder="Nom d'utilisateur" 
               style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
      </div>
      <div class="_w-text-area">
        <input type="password" id="loginPassword" placeholder="Mot de passe" 
               style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
      </div>
      <div id="loginError" style="color: #b81515; font-size: 12px; margin-top: 10px; display: none;"></div>
    </form>
    <div class="bg-bout">
      <button onclick="handleLogin()" class="_w-button red w-button">Me connecter</button>
      <div class="div-block-230">
        <div class="_w-courant">Ou</div>
      </div>
      <button onclick="handleGoogleLogin()" class="_w-button red w-button">Me connecter avec Gmail</button>
    </div>
  </div>

  <div class="div-block-232">
    <!-- COMPTE ANONYME -->
    <div class="_w-connect-bloc">
      <div class="dic-compte">
        <h3>Créer un compte anonyme *</h3>
        <form id="anonForm" class="user-pass" onsubmit="return false;">
          <div class="_w-text-area">
            <input type="text" id="anonUsername" placeholder="Nom d'utilisateur" 
                   style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
          </div>
          <div class="_w-text-area">
            <input type="password" id="anonPassword" placeholder="Mot de passe" 
                   style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
          </div>
          <div id="anonError" style="color: #b81515; font-size: 12px; margin-top: 10px; display: none;"></div>
        </form>
        <div class="bg-bout">
          <button onclick="handleAnonSignup()" class="_w-button w-button">Créer mon compte</button>
        </div>
      </div>
      <div class="_w-courant">* Pas de possibilité de notifications ni de récupération de mot de passe. Mais vous pourrez modifier plus tard dans votre espace personnel</div>
    </div>

    <!-- COMPTE AVEC EMAIL -->
    <div class="_w-connect-bloc">
      <div class="dic-compte">
        <h3>Créer un compte avec Email</h3>
        <form id="emailForm" class="user-pass" onsubmit="return false;">
          <div class="_w-text-area">
            <input type="text" id="emailUsername" placeholder="Nom d'utilisateur" 
                   style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
          </div>
          <div class="_w-text-area">
            <input type="password" id="emailPassword" placeholder="Mot de passe" 
                   style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
          </div>
          <div class="_w-text-area">
            <input type="email" id="emailAddress" placeholder="E-mail" 
                   style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
          </div>
          <div id="emailError" style="color: #b81515; font-size: 12px; margin-top: 10px; display: none;"></div>
        </form>
        <div class="bg-bout">
          <button onclick="handleEmailSignup()" class="_w-button w-button">Créer mon compte</button>
        </div>
      </div>
    </div>

    <!-- COMPTE AVEC GMAIL -->
    <div class="_w-connect-bloc">
      <div class="dic-compte">
        <h3>Créer un compte avec Gmail</h3>
        <form id="gmailForm" class="user-pass" onsubmit="return false;">
          <div class="_w-text-area">
            <input type="text" id="gmailUsername" placeholder="Nom d'utilisateur" 
                   style="width: 100%; padding: 8px; border: 1px solid #aca69a; border-radius: 5px;">
          </div>
          <div id="gmailError" style="color: #b81515; font-size: 12px; margin-top: 10px; display: none;"></div>
        </form>
        <div class="bg-bout">
          <button onclick="handleGmailSignup()" class="_w-button w-button">Créer mon compte avec Gmail</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Badge de version -->
<div style="position: fixed; bottom: 20px; left: 20px; background: #aca69a; color: white; padding: 5px 10px; border-radius: 3px; font-size: 10px; font-weight: 700;">
  V-2
</div>

<!-- Supabase Auth -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ============================================
// Configuration Supabase
// ============================================
const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;

// ============================================
// Fonctions utilitaires
// ============================================
function showError(elementId, message) {
    const el = document.getElementById(elementId);
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => {
        el.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    alert('✅ ' + message);
}

async function hashPassword(password) {
    const msgBuffer = new TextEncoder().encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

// ============================================
// CONNEXION STANDARD
// ============================================
async function handleLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
        showError('loginError', 'Veuillez remplir tous les champs');
        return;
    }

    try {
        const hashedPassword = await hashPassword(password);

        const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('username', username)
            .eq('password', hashedPassword)
            .single();

        if (error || !data) {
            showError('loginError', '❌ Identifiants incorrects !');
            return;
        }

        currentUser = data;
        showSuccess('Connexion réussie !');
        
        // Rediriger vers l'accueil
        if (window.router) {
            window.router.navigateTo('accueil');
        }

    } catch (error) {
        console.error('Erreur:', error);
        showError('loginError', 'Une erreur est survenue');
    }
}

// ============================================
// CONNEXION GOOGLE
// ============================================
async function handleGoogleLogin() {
    try {
        const redirectUrl = window.location.href.split('?')[0];
        
        const { data, error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: redirectUrl,
                skipBrowserRedirect: false
            }
        });

        if (error) throw error;

    } catch (error) {
        console.error('Erreur Google:', error);
        showError('loginError', 'Erreur lors de la connexion Google');
    }
}

// ============================================
// CRÉATION COMPTE ANONYME
// ============================================
async function handleAnonSignup() {
    const username = document.getElementById('anonUsername').value.trim();
    const password = document.getElementById('anonPassword').value;

    if (!username || !password) {
        showError('anonError', 'Veuillez remplir tous les champs');
        return;
    }

    if (password.length < 6) {
        showError('anonError', 'Le mot de passe doit contenir au moins 6 caractères');
        return;
    }

    try {
        const { data: existing } = await supabase
            .from('profiles')
            .select('username')
            .eq('username', username)
            .single();

        if (existing) {
            showError('anonError', 'Ce nom d\'utilisateur existe déjà');
            return;
        }

        const hashedPassword = await hashPassword(password);
        const userId = crypto.randomUUID();

        const { data, error } = await supabase
            .from('profiles')
            .insert([{
                id: userId,
                username: username,
                password: hashedPassword,
                auth_method: 'anonymous'
            }])
            .select();

        if (error) throw error;

        showSuccess('Compte créé ! Vous pouvez maintenant vous connecter.');
        document.getElementById('anonUsername').value = '';
        document.getElementById('anonPassword').value = '';

    } catch (error) {
        console.error('Erreur:', error);
        showError('anonError', 'Une erreur est survenue');
    }
}

// ============================================
// CRÉATION COMPTE AVEC EMAIL
// ============================================
async function handleEmailSignup() {
    const username = document.getElementById('emailUsername').value.trim();
    const password = document.getElementById('emailPassword').value;
    const email = document.getElementById('emailAddress').value.trim();

    if (!username || !password || !email) {
        showError('emailError', 'Veuillez remplir tous les champs');
        return;
    }

    if (password.length < 6) {
        showError('emailError', 'Le mot de passe doit contenir au moins 6 caractères');
        return;
    }

    try {
        const { data: existing } = await supabase
            .from('profiles')
            .select('username, email')
            .or(`username.eq.${username},email.eq.${email}`)
            .single();

        if (existing) {
            showError('emailError', 'Ce nom d\'utilisateur ou email existe déjà');
            return;
        }

        const hashedPassword = await hashPassword(password);
        const userId = crypto.randomUUID();

        const { data, error } = await supabase
            .from('profiles')
            .insert([{
                id: userId,
                username: username,
                email: email,
                password: hashedPassword,
                auth_method: 'email'
            }])
            .select();

        if (error) throw error;

        showSuccess('Compte créé ! Vous pouvez maintenant vous connecter.');
        document.getElementById('emailUsername').value = '';
        document.getElementById('emailAddress').value = '';
        document.getElementById('emailPassword').value = '';

    } catch (error) {
        console.error('Erreur:', error);
        showError('emailError', 'Une erreur est survenue');
    }
}

// ============================================
// CRÉATION COMPTE AVEC GMAIL
// ============================================
async function handleGmailSignup() {
    const username = document.getElementById('gmailUsername').value.trim();

    if (!username) {
        showError('gmailError', 'Veuillez entrer un nom d\'utilisateur');
        return;
    }

    try {
        const { data: existing } = await supabase
            .from('profiles')
            .select('username')
            .eq('username', username)
            .single();

        if (existing) {
            showError('gmailError', 'Ce nom d\'utilisateur existe déjà');
            return;
        }

        // Stocker le username temporairement pour l'utiliser après OAuth
        localStorage.setItem('pending_username', username);

        // Lancer l'authentification Google
        const redirectUrl = window.location.href.split('?')[0];
        
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: redirectUrl
            }
        });

        if (error) throw error;

    } catch (error) {
        console.error('Erreur:', error);
        showError('gmailError', 'Une erreur est survenue');
    }
}

// ============================================
// Gestion du retour OAuth
// ============================================
async function handleGoogleCallback() {
    const { data: { session } } = await supabase.auth.getSession();
    
    if (session) {
        const user = session.user;
        const pendingUsername = localStorage.getItem('pending_username');
        
        const { data: existing } = await supabase
            .from('profiles')
            .select('*')
            .eq('email', user.email)
            .single();

        if (!existing) {
            const username = pendingUsername || user.user_metadata?.full_name || user.email.split('@')[0];
            
            await supabase
                .from('profiles')
                .insert([{
                    id: user.id,
                    username: username,
                    email: user.email,
                    auth_method: 'google'
                }]);

            currentUser = {
                id: user.id,
                username: username,
                email: user.email,
                auth_method: 'google'
            };
            
            localStorage.removeItem('pending_username');
            showSuccess('Compte créé avec succès !');
        } else {
            currentUser = existing;
            showSuccess('Connexion réussie !');
        }
        
        // Rediriger vers l'accueil
        if (window.router) {
            window.router.navigateTo('accueil');
        }
    }
}

// ============================================
// Initialisation
// ============================================
handleGoogleCallback();

console.log('✅ Page de connexion V-2 chargée');
</script>
