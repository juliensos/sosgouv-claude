<!-- ============================================ -->
<!-- SOS-GOUV - Page Gouvernements Publiés -->
<!-- Affiche la liste des gouvernements depuis Supabase -->
<!-- ============================================ -->

<div class="page gouv-publi-s">
  <div class="div-govglobal">
    
    <!-- Menu boutons -->
    <div class="div-gov-menu">
      <a href="#" data-page="gouvernements" class="_w-link-bloc-button w-inline-block">
        <div class="text-block-52">📝</div>
        <div>ajouter un gouvernement</div>
      </a>
      <a href="#" data-page="personnalites" class="_w-link-bloc-button w-inline-block">
        <div class="text-block-52">👤</div>
        <div>ajouter une personnalité</div>
      </a>
      <a href="#" data-page="personnalites" class="_w-link-bloc-button blanc w-inline-block">
        <div class="text-block-52">📋</div>
        <div>Liste personnalités</div>
      </a>
    </div>

    <!-- Titre -->
    <div class="title-bloc">
      <h3 class="heading-3-gov">Gouvernements publiés</h3>
    </div>

    <!-- Filtres -->
    <div class="_w-selecta">
      <!-- Dropdown Type -->
      <div data-hover="false" data-delay="0" class="dropdown-4-copy w-dropdown">
        <div class="_w-dropdown-copy w-dropdown-toggle">
          <div class="fontello-icon grey">⚙</div>
          <div>Type</div>
        </div>
        <nav class="dropdown-list-4 w-dropdown-list">
          <a href="#" class="_w-dropdown-left _0 w-dropdown-link" onclick="setFilter('type', 'all'); return false;">Tous</a>
          <a href="#" class="_w-dropdown-left w-dropdown-link" onclick="setFilter('type', 'classique'); return false;">Classique</a>
          <a href="#" class="_w-dropdown-left w-dropdown-link" onclick="setFilter('type', 'hybride'); return false;">Hybride</a>
          <a href="#" class="_w-dropdown-left _2 w-dropdown-link" onclick="setFilter('type', 'cadavre'); return false;">Cadavre exquis</a>
        </nav>
      </div>

      <!-- Dropdown Trier par -->
      <div data-hover="false" data-delay="0" class="dropdown-4-copy w-dropdown">
        <div class="_w-dropdown-copy w-dropdown-toggle">
          <div class="fontello-icon grey">⚙</div>
          <div>Trier par</div>
        </div>
        <nav class="w-dropdown-list">
          <a href="#" class="_w-dropdown-left _0 w-dropdown-link" onclick="setFilter('sort', 'recent'); return false;">Plus récents</a>
          <a href="#" class="_w-dropdown-left w-dropdown-link" onclick="setFilter('sort', 'rating'); return false;">Mieux notés</a>
          <a href="#" class="_w-dropdown-left w-dropdown-link" onclick="setFilter('sort', 'votes'); return false;">Plus votés</a>
          <a href="#" class="_w-dropdown-left _2 w-dropdown-link" onclick="setFilter('sort', 'likes'); return false;">Popularité des membres</a>
        </nav>
      </div>

      <!-- Checkbox Prêt à gouverner -->
      <div class="form-block-7 w-form">
        <form id="email-form-2" name="email-form-2" data-name="Email Form 2" method="get">
          <label class="w-checkbox _w-dropdown-copy-copy">
            <div class="w-checkbox-input w-checkbox-input--inputType-custom checkbox" id="filterPretCheckbox"></div>
            <input type="checkbox" id="filterPret" name="checkbox" data-name="Checkbox" style="opacity:0;position:absolute;z-index:-1" onchange="applyFilters()"/>
            <span class="checkbox-label-2 w-form-label" for="checkbox">Prêt à gouverner</span>
          </label>
        </form>
      </div>
    </div>

    <!-- Container des gouvernements -->
    <div id="governmentsContainer">
      <div style="padding: 40px; text-align: center; color: var(--sos-grey-1);">
        ⏳ Chargement des gouvernements...
      </div>
    </div>

  </div>
</div>

<!-- Modal Détails -->
<div id="modalDetails" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; overflow-y: auto; padding: 20px;">
  <div style="max-width: 800px; margin: 40px auto; background: white; border-radius: 10px; position: relative;">
    <button onclick="closeModal()" style="position: absolute; top: 15px; right: 15px; background: var(--red); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold;">×</button>
    <div id="modalContent" style="padding: 40px;">
      <!-- Contenu généré dynamiquement -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ============================================
// Configuration Supabase
// ============================================
const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ============================================
// Variables globales
// ============================================
let allGovernments = [];
let allPersonalities = [];
let currentFilters = {
  type: 'all',
  sort: 'recent',
  pret: false
};
let pinnedGovs = JSON.parse(localStorage.getItem('sosgouv_pinned') || '[]');
let userVotes = JSON.parse(localStorage.getItem('sosgouv_votes') || '{}');

// ============================================
// Initialisation
// ============================================
async function init() {
  console.log('🚀 Initialisation de la page gouvernements...');
  await loadPersonalities();
  await loadGovernments();
}

// ============================================
// Charger les personnalités
// ============================================
async function loadPersonalities() {
  try {
    const { data, error } = await supabase
      .from('personalities')
      .select('*');
    
    if (error) throw error;
    
    allPersonalities = data || [];
    console.log(`✅ ${allPersonalities.length} personnalités chargées`);
  } catch (error) {
    console.error('❌ Erreur chargement personnalités:', error);
    allPersonalities = [];
  }
}

// ============================================
// Charger les gouvernements
// ============================================
async function loadGovernments() {
  try {
    const { data: govData, error: govError } = await supabase
      .from('governments')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (govError) throw govError;
    
    if (!govData || govData.length === 0) {
      console.log('ℹ️ Aucun gouvernement trouvé, création de données de test...');
      await createTestData();
      return;
    }
    
    // Charger les positions pour chaque gouvernement
    for (let gov of govData) {
      const { data: positions, error: posError } = await supabase
        .from('government_positions')
        .select('*')
        .eq('government_id', gov.id);
      
      gov.positions = positions || [];
    }
    
    allGovernments = govData;
    console.log(`✅ ${allGovernments.length} gouvernements chargés`);
    applyFilters();
    
  } catch (error) {
    console.error('❌ Erreur chargement gouvernements:', error);
    showError();
  }
}

// ============================================
// Créer des données de test
// ============================================
async function createTestData() {
  console.log('📝 Création de données de test...');
  
  // Créer quelques personnalités de test si aucune n'existe
  if (allPersonalities.length === 0) {
    const testPersonalities = [
      { name: 'Dupont', firstname: 'Jean', profession: 'Économiste', nombre_likes: 150 },
      { name: 'Martin', firstname: 'Marie', profession: 'Juriste', nombre_likes: 120 },
      { name: 'Bernard', firstname: 'Pierre', profession: 'Ingénieur', nombre_likes: 90 }
    ];
    
    for (let p of testPersonalities) {
      const { data } = await supabase.from('personalities').insert(p).select().single();
      if (data) allPersonalities.push(data);
    }
  }
  
  // Créer 2 gouvernements de test
  const testGovs = [
    {
      name: 'Gouvernement de Transition',
      type: 'classique',
      status: 'public',
      comment: 'Un gouvernement axé sur la transition écologique et la justice sociale.',
      rating: 4.5
    },
    {
      name: 'Gouvernement du Renouveau',
      type: 'hybride',
      status: 'public',
      comment: 'Pour une France innovante et inclusive.',
      rating: 4.2
    }
  ];
  
  for (let gov of testGovs) {
    const { data: newGov, error } = await supabase
      .from('governments')
      .insert(gov)
      .select()
      .single();
    
    if (newGov && allPersonalities.length > 0) {
      // Ajouter quelques positions
      await supabase.from('government_positions').insert([
        {
          government_id: newGov.id,
          personality_id: allPersonalities[0].id,
          sector: 'Matignon',
          title: 'Premier ministre'
        },
        {
          government_id: newGov.id,
          personality_id: allPersonalities[1].id,
          sector: 'Justice',
          title: 'Garde des Sceaux'
        }
      ]);
    }
  }
  
  // Recharger
  await loadGovernments();
}

// ============================================
// Appliquer les filtres
// ============================================
function setFilter(type, value) {
  currentFilters[type] = value;
  applyFilters();
}

function applyFilters() {
  currentFilters.pret = document.getElementById('filterPret').checked;
  
  let filtered = [...allGovernments];
  
  // Filtre par type
  if (currentFilters.type !== 'all') {
    filtered = filtered.filter(g => g.type === currentFilters.type);
  }
  
  // Filtre prêt à gouverner
  if (currentFilters.pret) {
    filtered = filtered.filter(g => g.status === 'public');
  }
  
  // Tri
  filtered.sort((a, b) => {
    switch (currentFilters.sort) {
      case 'recent':
        return new Date(b.created_at) - new Date(a.created_at);
      case 'rating':
        return (b.rating || 0) - (a.rating || 0);
      case 'votes':
        const votesA = Object.keys(userVotes).filter(k => k.startsWith(a.id)).length;
        const votesB = Object.keys(userVotes).filter(k => k.startsWith(b.id)).length;
        return votesB - votesA;
      case 'likes':
        return calculateTotalLikes(b) - calculateTotalLikes(a);
      default:
        return 0;
    }
  });
  
  renderGovernments(filtered);
}

// ============================================
// Calculer les likes totaux
// ============================================
function calculateTotalLikes(gov) {
  let total = 0;
  if (gov.positions) {
    gov.positions.forEach(pos => {
      const pers = allPersonalities.find(p => p.id === pos.personality_id);
      if (pers && pers.nombre_likes) {
        total += pers.nombre_likes;
      }
    });
  }
  return total;
}

// ============================================
// Afficher les gouvernements
// ============================================
function renderGovernments(governments) {
  const container = document.getElementById('governmentsContainer');
  
  if (governments.length === 0) {
    container.innerHTML = `
      <div style="padding: 60px 20px; text-align: center; color: var(--sos-grey-1);">
        <div style="font-size: 48px; margin-bottom: 20px;">🏛️</div>
        <h3>Aucun gouvernement trouvé</h3>
        <p>Soyez le premier à créer un gouvernement !</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = governments.map(gov => renderGovernmentCard(gov)).join('');
}

// ============================================
// Rendu d'une carte gouvernement
// ============================================
function renderGovernmentCard(gov) {
  const totalLikes = calculateTotalLikes(gov);
  const isPinned = pinnedGovs.includes(gov.id);
  const date = new Date(gov.created_at).toLocaleDateString('fr-FR');
  
  // Statut et type
  const statusBadge = gov.status === 'public' 
    ? '<div class="_w-courant _w-bold _w-vert">Prêt à gouverner</div>'
    : '<div class="_w-courant _w-grey">En attente</div>';
  
  const typeClass = gov.type === 'classique' ? 'classique' : 
                   gov.type === 'hybride' ? 'fiche' : 'note-moy';
  
  // Membres (max 5)
  const positions = gov.positions || [];
  const displayPositions = positions.slice(0, 5);
  const hasMore = positions.length > 5;
  
  const membersHTML = displayPositions.map(pos => {
    const pers = allPersonalities.find(p => p.id === pos.personality_id);
    if (!pers) return '';
    
    return `
      <div class="_w-courant-div">
        <div class="_w-courant _w-bold">${pers.firstname} ${pers.name}</div>
        <div class="div-block-214">
          <div class="_w-courant _w-grey">${pos.title}</div>
        </div>
      </div>
    `;
  }).join('');
  
  // Note moyenne
  const rating = gov.rating || 0;
  const stars = '⭐'.repeat(Math.round(rating));
  
  return `
    <div class="gov-bloc">
      <div class="bloc-gov-list">
        <!-- En-tête -->
        <div class="bloc-en-tete">
          <h4 class="heading-4">${gov.name}</h4>
          <div class="_w-courant-div">
            <div class="_w-courant _w-bold _w-pink">${rating.toFixed(1)} / 5</div>
            ${statusBadge}
          </div>
        </div>
        
        <!-- Description -->
        ${gov.comment ? `
          <div class="descript">
            <p class="paragraph-2">${gov.comment}</p>
          </div>
        ` : ''}
        
        <!-- Membres (max 5) -->
        <div class="membres">
          ${membersHTML}
          ${hasMore ? `<div class="_w-courant _w-grey" style="margin-top: 10px;">+ ${positions.length - 5} autres membres...</div>` : ''}
        </div>
        
        <!-- Bouton Détail -->
        <div class="detail" onclick="showDetails('${gov.id}')">
          <div class="fontello-white">👁</div>
          <div class="mini-current mini-bold black">Détail</div>
        </div>
      </div>
      
      <!-- Infos et actions -->
      <div class="block-gov-infos">
        <div class="infos">
          <!-- Étoiles -->
          <div class="_w-courant-div">
            <div class="fontello-rose">${stars}</div>
          </div>
          
          <!-- Nombre de votes -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Nombre de votes</div>
            <div class="_w-courant _w-bold _w-pink">500</div>
          </div>
          
          <!-- Type -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini">Type</div>
            <div class="mini-current ${typeClass}">${gov.type}</div>
          </div>
          
          <!-- Date et auteur -->
          <div class="_w-courant-div">
            <div class="_w-courant _w-mini _w-white">Publié le ${date} par</div>
            <a href="#" class="_w-user">utilisateur</a>
          </div>
          
          <!-- Likes totaux -->
          ${totalLikes > 0 ? `
            <div class="_w-courant-div">
              <div class="_w-courant _w-mini">Likes cumulés</div>
              <div class="_w-courant _w-bold _w-pink">${totalLikes}</div>
            </div>
          ` : ''}
        </div>
        
        <!-- Actions -->
        <div class="send-et-pin">
          <div class="envoyer" onclick="shareByEmail('${gov.id}')">
            <div class="fontello-white">📧</div>
            <div class="mini-current mini-bold">Envoyer</div>
          </div>
          <div class="envoyer" onclick="togglePin('${gov.id}')" style="background-color: ${isPinned ? 'var(--sos-green)' : '#000'};">
            <div class="fontello-white">${isPinned ? '✓' : '📌'}</div>
            <div class="mini-current mini-bold">${isPinned ? 'Épinglé' : 'Épingler'}</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ============================================
// Afficher les détails (modal)
// ============================================
function showDetails(govId) {
  const gov = allGovernments.find(g => g.id === govId);
  if (!gov) return;
  
  const positions = gov.positions || [];
  const totalLikes = calculateTotalLikes(gov);
  const date = new Date(gov.created_at).toLocaleDateString('fr-FR', { 
    year: 'numeric', month: 'long', day: 'numeric' 
  });
  
  const membersHTML = positions.map(pos => {
    const pers = allPersonalities.find(p => p.id === pos.personality_id);
    if (!pers) return '';
    
    return `
      <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--color);">
        <div style="font-weight: bold; color: #333; font-size: 1.1em;">${pers.firstname} ${pers.name}</div>
        <div style="color: #666; margin-top: 5px;">
          <strong>${pos.sector}</strong> - ${pos.title}
          ${pos.custom_title ? `<br><em>En charge de : ${pos.custom_title}</em>` : ''}
          ${pers.nombre_likes ? `<br><span style="background: var(--color); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.85em;">❤️ ${pers.nombre_likes} likes</span>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  document.getElementById('modalContent').innerHTML = `
    <h2 style="color: var(--color); margin-bottom: 10px;">${gov.name}</h2>
    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; font-size: 0.9em;">
      <span>📅 ${date}</span>
      <span style="background: var(--sos-yellow2); padding: 3px 10px; border-radius: 15px; font-weight: bold;">${gov.type.toUpperCase()}</span>
      <span>⭐ ${(gov.rating || 0).toFixed(1)}/5</span>
      ${totalLikes > 0 ? `<span style="background: var(--color); color: white; padding: 3px 10px; border-radius: 15px;">❤️ ${totalLikes} likes cumulés</span>` : ''}
    </div>
    
    ${gov.comment ? `
      <div style="background: #fff9e6; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid var(--sos-yellow);">
        <h3 style="color: var(--color); margin-bottom: 10px;">💬 Vision de l'auteur</h3>
        <p style="color: #555; line-height: 1.6; margin: 0;">${gov.comment}</p>
      </div>
    ` : ''}
    
    <div>
      <h3 style="color: var(--color); margin-bottom: 15px; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">
        👥 Composition du Gouvernement (${positions.length})
      </h3>
      ${membersHTML}
    </div>
  `;
  
  document.getElementById('modalDetails').style.display = 'block';
}

function closeModal() {
  document.getElementById('modalDetails').style.display = 'none';
}

// ============================================
// Épingler/Désépingler
// ============================================
function togglePin(govId) {
  const index = pinnedGovs.indexOf(govId);
  
  if (index > -1) {
    pinnedGovs.splice(index, 1);
    alert('📌 Gouvernement retiré de vos épinglés');
  } else {
    pinnedGovs.push(govId);
    alert('✅ Gouvernement épinglé !');
  }
  
  localStorage.setItem('sosgouv_pinned', JSON.stringify(pinnedGovs));
  applyFilters();
}

// ============================================
// Partager par email
// ============================================
function shareByEmail(govId) {
  const gov = allGovernments.find(g => g.id === govId);
  if (!gov) return;
  
  const email = prompt('📧 Entrez l\'adresse email :');
  if (!email) return;
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('❌ Email invalide');
    return;
  }
  
  const subject = encodeURIComponent(`Découvrez "${gov.name}" sur SOS-GOUV`);
  const body = encodeURIComponent(
    `Bonjour,\n\nDécouvrez ce gouvernement sur SOS-GOUV :\n\n` +
    `"${gov.name}"\n` +
    `${gov.comment ? `\n${gov.comment}\n` : ''}` +
    `\nCordialement`
  );
  
  window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
  alert('✅ Email préparé !');
}

// ============================================
// Afficher une erreur
// ============================================
function showError() {
  document.getElementById('governmentsContainer').innerHTML = `
    <div style="padding: 40px; text-align: center;">
      <h3 style="color: var(--red); margin-bottom: 20px;">❌ Erreur de chargement</h3>
      <p style="color: var(--sos-grey-1); margin-bottom: 20px;">
        Impossible de charger les gouvernements depuis Supabase
      </p>
      <button onclick="init()" style="background: var(--sos-yellow); color: #000; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold;">
        ↻ Réessayer
      </button>
    </div>
  `;
}

// ============================================
// Fermer modal si clic en dehors
// ============================================
document.addEventListener('click', (e) => {
  if (e.target.id === 'modalDetails') {
    closeModal();
  }
});

// ============================================
// Lancer l'initialisation
// ============================================
init();
</script>
