<!DOCTYPE html>
<html data-wf-domain="sosgouv.webflow.io" data-wf-page="68f00317ba745372947ddeee" data-wf-site="68ecfda4d9b3270b98426ff5" data-wf-status="1" lang="fr">
<head>
    <meta charset="utf-8"/>
    <title>SOS-GOUV - Cr√©er un Gouvernement</title>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <link href="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/css/sosgouv.webflow.shared.36acaafc4.css" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin="anonymous"/>
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js" type="text/javascript"></script>
    <script type="text/javascript">WebFont.load({ google: { families: ["Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic"] }});</script>
    <script type="text/javascript">!function(o,c){var n=c.documentElement,t=" w-mod-";n.className+=t+"js",("ontouchstart"in o||o.DocumentTouch&&c instanceof DocumentTouch)&&(n.className+=t+"touch")}(window,document);</script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Styles additionnels pour l'autocomplete */
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .autocomplete-results.show {
            display: block;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .autocomplete-item:hover {
            background: #f8f9fa;
        }
        .selected-personality {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .selected-personality.show {
            display: block;
        }
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .cancel-btn {
            background: #6c757d;
            color: white;
        }
        .save-btn {
            background: #28a745;
            color: white;
        }
        /* Style pour le wrapper de recherche */
        .search-wrapper {
            position: relative;
            flex: 1;
        }
    </style>
</head>
<body class="body">
    <div class="page gouv-classique">
        <div data-current="Tab 1" data-easing="ease" data-duration-in="300" data-duration-out="100" class="w-tabs">
            <div class="tabs-menu-4 w-tab-menu">
                <a data-w-tab="Tab 1" class="tab-link-tab-1-6 w-inline-block w-tab-link w--current">
                    <div>Classique</div>
                </a>
                <a data-w-tab="Tab 2" class="tab-link-tab-1-6 w-inline-block w-tab-link">
                    <div>Hybride</div>
                </a>
            </div>
            
            <div class="w-tab-content">
                <!-- ONGLET CLASSIQUE -->
                <div data-w-tab="Tab 1" class="w-tab-pane w--tab-active">
                    <div class="classic">
                        <div class="_w-text-area _1">
                            <input type="text" id="govName" placeholder="Nom du gouvernement*" style="width: 100%; border: none; background: transparent; font-size: 1.5em; font-weight: bold;">
                        </div>
                        <div class="_w-text-area">
                            <textarea id="govComment" class="_w-courant grey" placeholder="Vision de l'auteur" style="width: 100%; min-height: 60px; border: none; background: transparent; resize: vertical;"></textarea>
                        </div>
                        
                        <div class="div-postes" id="positionsContainer">
                            <!-- Les postes seront g√©n√©r√©s ici par JavaScript -->
                        </div>

                        <!-- Section Ministres D√©l√©gu√©s -->
                        <div class="div-postes" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                            <h3 style="margin-bottom: 20px;">üéØ Ministres D√©l√©gu√©s</h3>
                            <div style="margin-bottom: 20px;">
                                <a href="#" class="_w-link-bloc-button add-ministere w-inline-block" onclick="addDelegate(); return false;">
                                    <div class="text-block-52"></div>
                                    <div>Ajouter un ministre d√©l√©gu√©</div>
                                </a>
                            </div>
                            <div id="delegatesContainer"></div>
                        </div>

                        <div class="pubis-utons">
                            <a href="#" class="_w-link-bloc-button bbrouillon w-inline-block" onclick="saveDraft(); return false;">
                                <div class="text-block-52"></div>
                                <div>Brouillons</div>
                            </a>
                            <a href="#" class="_w-link-bloc-button publier w-inline-block" onclick="submitGovernment(); return false;">
                                <div class="text-block-52"></div>
                                <div>Publier</div>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- ONGLET HYBRIDE -->
                <div data-w-tab="Tab 2" class="w-tab-pane">
                    <div class="classic">
                        <div class="_w-text-area _1">
                            <input type="text" id="govNameHybride" placeholder="Nom du gouvernement*" style="width: 100%; border: none; background: transparent; font-size: 1.5em; font-weight: bold;">
                        </div>
                        <div class="_w-text-area">
                            <textarea id="govCommentHybride" class="_w-courant grey" placeholder="Vision de l'auteur" style="width: 100%; min-height: 60px; border: none; background: transparent; resize: vertical;"></textarea>
                        </div>
                        
                        <div class="div-postes" id="positionsContainerHybride">
                            <!-- Structure hybride - √† impl√©menter selon besoin -->
                            <p style="padding: 20px; text-align: center; color: #999;">
                                üìã L'interface hybride est en cours de d√©veloppement.<br>
                                Utilisez l'onglet "Classique" pour cr√©er votre gouvernement.
                            </p>
                        </div>

                        <div class="pubis-utons">
                            <a href="#" class="_w-link-bloc-button bbrouillon w-inline-block">
                                <div class="text-block-52"></div>
                                <div>Brouillons</div>
                            </a>
                            <a href="#" class="_w-link-bloc-button publier w-inline-block">
                                <div class="text-block-52"></div>
                                <div>Publier</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ajout Personnalit√© -->
    <div id="addPersonalityModal" class="modal">
        <div class="modal-content">
            <h3>‚ûï Ajouter une Personnalit√©</h3>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Nom :</label>
                <input type="text" id="newPersonName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Pr√©nom :</label>
                <input type="text" id="newPersonFirstname" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
            <div class="modal-buttons">
                <button class="cancel-btn" onclick="closeModal()">Annuler</button>
                <button class="save-btn" onclick="saveNewPersonality()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script src="https://d3e54v103j8qbb.cloudfront.net/js/jquery-3.5.1.min.dc5e7f18c8.js?site=68ecfda4d9b3270b98426ff5" type="text/javascript" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/js/webflow.schunk.50d850aa4962b686.js" type="text/javascript"></script>
    <script src="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/js/webflow.schunk.df51416057db8a96.js" type="text/javascript"></script>
    <script src="https://cdn.prod.website-files.com/68ecfda4d9b3270b98426ff5/js/webflow.8f7aba30.b9f83e0e165b56bf.js" type="text/javascript"></script>

    <script>
        const SUPABASE_URL = 'https://ubttetrqvvbcgvwjbylr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVidHRldHJxdnZiY2d2d2pieWxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjM1NzYsImV4cCI6MjA3NjE5OTU3Nn0.xYm8PvgsMu7oTALS3nakrNGLCbgHKDF8lN9PiOj7QVQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Structure des 22 minist√®res classiques
        const CLASSIC_POSITIONS = [
            { sector: 'Matignon', title: 'Premier ministre', subsectors: ['Coordination gouvernementale', 'Relations avec le Parlement', 'Services du Premier ministre'] },
            { sector: 'Justice', title: 'Garde des Sceaux, ministre de la Justice', subsectors: ['Justice judiciaire', 'Justice administrative', 'Administration p√©nitentiaire', 'Aide aux victimes'] },
            { sector: 'Int√©rieur', title: 'Ministre de l\'Int√©rieur', subsectors: ['S√©curit√©', 'Immigration', 'Collectivit√©s territoriales', 'Police nationale'] },
            { sector: 'D√©fense', title: 'Ministre des Arm√©es', subsectors: ['Arm√©e de terre', 'Marine nationale', 'Arm√©e de l\'air et de l\'espace', 'Gendarmerie nationale'] },
            { sector: 'Affaires √©trang√®res', title: 'Ministre de l\'Europe et des Affaires √©trang√®res', subsectors: ['Diplomatie', 'Coop√©ration internationale', 'Francophonie', 'Commerce ext√©rieur'] },
            { sector: '√âconomie', title: 'Ministre de l\'√âconomie et des Finances', subsectors: ['Budget', 'Fiscalit√©', 'Politique √©conomique', 'Industrie'] },
            { sector: '√âducation', title: 'Ministre de l\'√âducation nationale', subsectors: ['Enseignement primaire', 'Enseignement secondaire', 'Programmes scolaires', 'Vie scolaire'] },
            { sector: 'Enseignement sup√©rieur', title: 'Ministre de l\'Enseignement sup√©rieur et de la Recherche', subsectors: ['Universit√©s', 'Recherche scientifique', 'Innovation', 'Vie √©tudiante'] },
            { sector: 'Sant√©', title: 'Ministre de la Sant√©', subsectors: ['H√¥pitaux', 'Sant√© publique', 'Pr√©vention', 'Personnes √¢g√©es'] },
            { sector: 'Solidarit√©s', title: 'Ministre des Solidarit√©s', subsectors: ['Handicap', 'Famille', 'Enfance', 'Protection sociale'] },
            { sector: 'Travail', title: 'Ministre du Travail', subsectors: ['Emploi', 'Formation professionnelle', 'Relations sociales', 'Inspection du travail'] },
            { sector: 'Agriculture', title: 'Ministre de l\'Agriculture et de la Souverainet√© alimentaire', subsectors: ['Agriculture', 'P√™che', 'Alimentation', 'For√™t'] },
            { sector: 'Environnement', title: 'Ministre de la Transition √©cologique', subsectors: ['Biodiversit√©', 'Climat', 'Pollution', '√âconomie circulaire'] },
            { sector: '√ânergie', title: 'Ministre de la Transition √©nerg√©tique', subsectors: ['√ânergies renouvelables', 'Nucl√©aire', 'Efficacit√© √©nerg√©tique', 'Mix √©nerg√©tique'] },
            { sector: 'Am√©nagement du territoire', title: 'Ministre de la Coh√©sion des territoires', subsectors: ['Am√©nagement territorial', 'Politique de la ville', 'Ruralit√©', 'D√©centralisation'] },
            { sector: 'Culture', title: 'Ministre de la Culture', subsectors: ['Patrimoine', 'Arts', 'M√©dias', 'Cin√©ma'] },
            { sector: 'Sports', title: 'Ministre des Sports et des Jeux Olympiques', subsectors: ['Sport professionnel', 'Sport amateur', 'Grandes manifestations', 'Sport sant√©'] },
            { sector: 'Logement', title: 'Ministre du Logement', subsectors: ['Habitat social', 'Urbanisme', 'Construction', 'R√©novation urbaine'] },
            { sector: 'Transports', title: 'Ministre des Transports', subsectors: ['Transport ferroviaire', 'Transport routier', 'Transport a√©rien', 'Transport maritime'] },
            { sector: 'Mer', title: 'Ministre de la Mer', subsectors: ['P√™che maritime', 'Ports', '√âconomie maritime', 'Littoral'] },
            { sector: 'Outre-mer', title: 'Ministre des Outre-mer', subsectors: ['DOM-TOM', 'D√©veloppement ultramarin', 'Coop√©ration r√©gionale'] },
            { sector: 'Fonction publique', title: 'Ministre de la Transformation et de la Fonction publiques', subsectors: ['Administration publique', 'Modernisation', 'Num√©rique', 'Simplification'] }
        ];

        const ALL_SUBSECTORS = [];
        CLASSIC_POSITIONS.forEach(pos => {
            pos.subsectors.forEach(sub => {
                ALL_SUBSECTORS.push({ sector: pos.sector, subsector: sub });
            });
        });

        let personalities = [];
        let governmentData = { positions: [] };
        let currentPositionIndex = null;

        // Charger les personnalit√©s
        async function loadPersonalities() {
            const { data, error } = await supabase.from('personalities').select('*').order('name');
            if (data) {
                personalities = data;
                console.log('‚úÖ Personnalit√©s charg√©es:', personalities.length);
            } else {
                console.error('‚ùå Erreur chargement:', error);
            }
        }

        // G√©n√©rer les options group√©es par profession
        function getPersonalityOptions() {
            const grouped = {};
            personalities.forEach(p => {
                const prof = p.profession || 'Sans profession';
                if (!grouped[prof]) grouped[prof] = [];
                grouped[prof].push(p);
            });

            const sorted = Object.keys(grouped).sort();
            let html = '<option value="">-- S√©lectionner par profession --</option>';
            sorted.forEach(prof => {
                html += `<optgroup label="${prof}">`;
                grouped[prof].forEach(p => {
                    html += `<option value="${p.id}">${p.firstname} ${p.name}</option>`;
                });
                html += '</optgroup>';
            });
            return html;
        }

        // Rendre les postes classiques
        function renderPositions() {
            const container = document.getElementById('positionsContainer');
            container.innerHTML = '';

            CLASSIC_POSITIONS.forEach((pos, index) => {
                const card = document.createElement('div');
                card.className = '_w-bloc-poste';
                card.innerHTML = `
                    <div class="bloc-poste-ligne1">
                        <div class="bloc-poste-grouped">
                            <div class="_w-courant _w-grey _w-mini">Secteur</div>
                            <div class="secteur">${pos.sector}</div>
                        </div>
                        <div class="bloc-poste-grouped">
                            <div class="_w-courant _w-grey _w-mini">Fonction</div>
                            <div class="ministre">${pos.title}</div>
                        </div>
                        <div class="bloc-poste-grouped _3">
                            <div class="_w-courant _w-grey _w-mini">Intitul√© personnalis√© pour affiner votre vision</div>
                            <div class="_w-text-area">
                                <input type="text" id="custom-${index}" class="_w-courant _w-bold-grey" placeholder="et de‚Ä¶ / en charge de‚Ä¶" style="border: none; background: transparent; width: 100%;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="bloc-poste-grouped _2">
                        <div class="div-block-223">
                            <div class="_w-courant _w-grey _w-mini">Sous-Secteur</div>
                            <div class="_w-courant _w-mini">${pos.subsectors.join(', ')}</div>
                        </div>
                    </div>

                    <div class="bloc-gouv-loupe">
                        <div data-hover="false" data-delay="0" class="dropdown-4 w-dropdown" style="flex: 1; position: relative;">
                            <div class="search-wrapper">
                                <input type="text" id="search-${index}" placeholder="üîç Rechercher une personnalit√© ‚Ä¶" 
                                       oninput="searchPersonality(${index})" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <div class="autocomplete-results" id="results-${index}"></div>
                            </div>
                        </div>
                        
                        <div data-hover="false" data-delay="0" class="dropdown-4 w-dropdown" style="flex: 1;">
                            <select id="select-${index}" onchange="selectFromDropdown(${index})" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                ${getPersonalityOptions()}
                            </select>
                        </div>
                        
                        <a href="#" class="_w-button w2 w-button" onclick="openAddPersonalityModal(${index}); return false;">‚Ä¶ ou ajoutez la.</a>
                    </div>
                    
                    <div class="selected-personality" id="selected-${index}"></div>
                `;
                container.appendChild(card);
            });
        }

        // Recherche personnalit√©
        window.searchPersonality = function(index) {
            const input = document.getElementById(`search-${index}`);
            const results = document.getElementById(`results-${index}`);
            const query = input.value.toLowerCase();

            if (query.length < 1) {
                results.classList.remove('show');
                return;
            }

            const filtered = personalities.filter(p => 
                p.name.toLowerCase().startsWith(query) || 
                p.firstname.toLowerCase().startsWith(query)
            );

            if (filtered.length === 0) {
                results.innerHTML = '<div style="padding: 10px; color: #999;">Aucune personnalit√© trouv√©e</div>';
            } else {
                results.innerHTML = filtered.map(p => `
                    <div class="autocomplete-item" onclick="selectPersonality(${index}, '${p.id}')">
                        <strong>${p.firstname} ${p.name}</strong>${p.profession ? ' - ' + p.profession : ''}
                    </div>
                `).join('');
            }
            results.classList.add('show');
        };

        // S√©lectionner personnalit√©
        window.selectPersonality = function(index, personalityId) {
            const p = personalities.find(per => String(per.id) === String(personalityId));
            if (!p) return;

            const searchInput = document.getElementById(`search-${index}`);
            const results = document.getElementById(`results-${index}`);
            const selected = document.getElementById(`selected-${index}`);
            const select = document.getElementById(`select-${index}`);

            if (searchInput) searchInput.value = `${p.firstname} ${p.name}`;
            if (results) results.classList.remove('show');
            if (select) select.value = personalityId;
            if (selected) {
                selected.innerHTML = `<strong>‚úÖ S√©lectionn√© :</strong> ${p.firstname} ${p.name}`;
                selected.classList.add('show');
            }

            if (!governmentData.positions[index]) governmentData.positions[index] = {};
            governmentData.positions[index].personalityId = personalityId;
        };

        window.selectFromDropdown = function(index) {
            const select = document.getElementById(`select-${index}`);
            if (select?.value) selectPersonality(index, select.value);
        };

        window.openAddPersonalityModal = function(index) {
            currentPositionIndex = index;
            document.getElementById('addPersonalityModal').classList.add('show');
        };

        window.closeModal = function() {
            document.getElementById('addPersonalityModal').classList.remove('show');
            document.getElementById('newPersonName').value = '';
            document.getElementById('newPersonFirstname').value = '';
        };

        window.saveNewPersonality = async function() {
            const name = document.getElementById('newPersonName').value;
            const firstname = document.getElementById('newPersonFirstname').value;

            if (!name || !firstname) {
                alert('Nom et pr√©nom obligatoires');
                return;
            }

            const { data, error } = await supabase.from('personalities').insert([{ name, firstname, status: 'neant' }]).select();
            if (error) {
                alert('Erreur : ' + error.message);
                return;
            }

            personalities.push(data[0]);
            closeModal();
            selectPersonality(currentPositionIndex, data[0].id);
            renderPositions();
            alert('‚úÖ Personnalit√© ajout√©e !');
        };

        // Ajouter d√©l√©gu√©
        window.addDelegate = function() {
            const container = document.getElementById('delegatesContainer');
            const id = Date.now();

            const subsectorsOptions = ALL_SUBSECTORS.map(item => 
                `<option value="${item.sector}|${item.subsector}">${item.sector} - ${item.subsector}</option>`
            ).join('');

            const card = document.createElement('div');
            card.className = '_w-bloc-poste';
            card.id = `delegate-${id}`;
            card.style.marginTop = '15px';
            card.style.borderLeft = '4px solid #667eea';
            card.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <strong>Ministre d√©l√©gu√©</strong>
                    <button onclick="removeDelegate(${id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">‚ùå Retirer</button>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div class="_w-courant _w-grey _w-mini">Rattachement</div>
                    <select id="delegate-sector-${id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">-- S√©lectionner --</option>
                        ${subsectorsOptions}
                    </select>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <div class="_w-courant _w-grey _w-mini">En charge de</div>
                    <input type="text" id="delegate-title-${id}" placeholder="Ex: la transition num√©rique" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                </div>

                <div class="bloc-gouv-loupe">
                    <div class="search-wrapper" style="flex: 1; position: relative;">
                        <input type="text" id="delegate-search-${id}" placeholder="üîç Rechercher‚Ä¶" 
                               oninput="searchDelegatePersonality('${id}')" 
                               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <div class="autocomplete-results" id="delegate-results-${id}"></div>
                    </div>
                    
                    <select id="delegate-select-${id}" onchange="selectDelegateFromDropdown('${id}')" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        ${getPersonalityOptions()}
                    </select>
                </div>
                
                <div class="selected-personality" id="delegate-selected-${id}"></div>
            `;
            container.appendChild(card);
        };

        window.removeDelegate = function(id) {
            document.getElementById(`delegate-${id}`)?.remove();
        };

        window.searchDelegatePersonality = function(delegateId) {
            const input = document.getElementById(`delegate-search-${delegateId}`);
            const results = document.getElementById(`delegate-results-${delegateId}`);
            const query = input?.value.toLowerCase() || '';

            if (query.length < 1) {
                results?.classList.remove('show');
                return;
            }

            const filtered = personalities.filter(p => 
                p.name.toLowerCase().startsWith(query) || 
                p.firstname.toLowerCase().startsWith(query)
            );

            if (filtered.length === 0) {
                results.innerHTML = '<div style="padding: 10px; color: #999;">Aucune personnalit√© trouv√©e</div>';
            } else {
                results.innerHTML = filtered.map(p => `
                    <div class="autocomplete-item" onclick="selectDelegatePersonality('${delegateId}', '${p.id}')">
                        <strong>${p.firstname} ${p.name}</strong>${p.profession ? ' - ' + p.profession : ''}
                    </div>
                `).join('');
            }
            results?.classList.add('show');
        };

        window.selectDelegatePersonality = function(delegateId, personalityId) {
            const p = personalities.find(per => String(per.id) === String(personalityId));
            if (!p) return;

            const searchInput = document.getElementById(`delegate-search-${delegateId}`);
            const results = document.getElementById(`delegate-results-${delegateId}`);
            const selected = document.getElementById(`delegate-selected-${delegateId}`);
            const select = document.getElementById(`delegate-select-${delegateId}`);

            if (searchInput) {
                searchInput.value = `${p.firstname} ${p.name}`;
                searchInput.dataset.personalityId = personalityId;
            }
            if (results) results.classList.remove('show');
            if (select) select.value = personalityId;
            if (selected) {
                selected.innerHTML = `<strong>‚úÖ S√©lectionn√© :</strong> ${p.firstname} ${p.name}`;
                selected.classList.add('show');
            }
        };

        window.selectDelegateFromDropdown = function(delegateId) {
            const select = document.getElementById(`delegate-select-${delegateId}`);
            if (select?.value) selectDelegatePersonality(delegateId, select.value);
        };

        window.saveDraft = function() {
            const name = document.getElementById('govName').value;
            if (!name) {
                alert('Veuillez donner un nom au gouvernement');
                return;
            }
            alert('üíæ Brouillon sauvegard√© : ' + name);
        };

        window.submitGovernment = async function() {
            const name = document.getElementById('govName').value;
            const comment = document.getElementById('govComment').value;
            
            if (!name) {
                alert('Veuillez donner un nom au gouvernement');
                return;
            }

            // R√©cup√©rer l'utilisateur depuis localStorage (m√©thode de votre app)
            const userStr = localStorage.getItem('sosgouv_user');
            if (!userStr) {
                alert('‚ö†Ô∏è Vous devez √™tre connect√© pour publier un gouvernement');
                return;
            }

            let userId;
            try {
                const userData = JSON.parse(userStr);
                userId = userData.id;
                console.log('‚úÖ Utilisateur connect√©:', userData.username || userData.email);
            } catch (error) {
                console.error('‚ùå Erreur lecture utilisateur:', error);
                alert('‚ö†Ô∏è Erreur: impossible de lire les donn√©es utilisateur');
                return;
            }

            // Collecter les positions
            const positions = [];
            CLASSIC_POSITIONS.forEach((pos, index) => {
                if (governmentData.positions[index]?.personalityId) {
                    const customTitle = document.getElementById(`custom-${index}`)?.value || '';
                    positions.push({
                        sector: pos.sector,
                        title: pos.title,
                        custom_title: customTitle,
                        subsectors: pos.subsectors.join(', '), // Format avec virgules
                        personality_id: governmentData.positions[index].personalityId
                    });
                }
            });

            if (positions.length === 0) {
                alert('Veuillez s√©lectionner au moins un ministre');
                return;
            }

            // Collecter les d√©l√©gu√©s
            const delegates = [];
            document.querySelectorAll('[id^="delegate-"]').forEach(card => {
                if (!card.id.includes('sector') && !card.id.includes('title') && !card.id.includes('search') && !card.id.includes('select') && !card.id.includes('results') && !card.id.includes('selected')) {
                    const delegateId = card.id.split('-')[1];
                    const sectorSelect = document.getElementById(`delegate-sector-${delegateId}`);
                    const titleInput = document.getElementById(`delegate-title-${delegateId}`);
                    const searchInput = document.getElementById(`delegate-search-${delegateId}`);
                    
                    if (sectorSelect?.value && titleInput?.value && searchInput?.dataset.personalityId) {
                        const [sector, subsector] = sectorSelect.value.split('|');
                        delegates.push({
                            sector: sector,
                            title: titleInput.value,
                            subsectors: subsector, // Un seul subsector pour les d√©l√©gu√©s
                            personality_id: searchInput.dataset.personalityId
                        });
                    }
                }
            });

            console.log('üì§ Publication du gouvernement...');
            console.log('Positions:', positions.length);
            console.log('D√©l√©gu√©s:', delegates.length);

            try {
                // 1. Ins√©rer le gouvernement
                const { data: govData, error: govError } = await supabase
                    .from('governments')
                    .insert([{
                        name: name,
                        type: 'classique',
                        comment: comment || null,
                        created_by: userId,
                        status: 'published'
                        // Pas de rating √† l'insertion - sera calcul√© avec les votes
                    }])
                    .select();

                if (govError) {
                    console.error('‚ùå Erreur gouvernement:', govError);
                    alert('Erreur lors de la cr√©ation du gouvernement : ' + govError.message);
                    return;
                }

                const governmentId = govData[0].id;
                console.log('‚úÖ Gouvernement cr√©√©:', governmentId);

                // 2. Ins√©rer les positions minist√©rielles (is_delegate = false)
                const positionsToInsert = positions.map(pos => ({
                    government_id: governmentId,
                    sector: pos.sector,
                    title: pos.title,
                    custom_title: pos.custom_title || null,
                    subsectors: pos.subsectors,
                    personality_id: pos.personality_id,
                    is_delegate: false
                }));

                const { error: posError } = await supabase
                    .from('government_positions')
                    .insert(positionsToInsert);

                if (posError) {
                    console.error('‚ùå Erreur positions:', posError);
                    alert('Erreur lors de l\'ajout des positions : ' + posError.message);
                    return;
                }

                console.log('‚úÖ Positions cr√©√©es');

                // 3. Ins√©rer les d√©l√©gu√©s si pr√©sents (is_delegate = true)
                if (delegates.length > 0) {
                    const delegatesToInsert = delegates.map(del => ({
                        government_id: governmentId,
                        sector: del.sector,
                        title: del.title,
                        custom_title: null,
                        subsectors: del.subsectors,
                        personality_id: del.personality_id,
                        is_delegate: true
                    }));

                    const { error: delError } = await supabase
                        .from('government_positions')
                        .insert(delegatesToInsert);

                    if (delError) {
                        console.error('‚ùå Erreur d√©l√©gu√©s:', delError);
                        alert('Erreur lors de l\'ajout des d√©l√©gu√©s : ' + delError.message);
                        return;
                    } else {
                        console.log('‚úÖ D√©l√©gu√©s cr√©√©s');
                    }
                }

                alert(`‚úÖ Gouvernement publi√© !\n\n"${name}"\n${positions.length} ministres${delegates.length > 0 ? `\n${delegates.length} d√©l√©gu√©s` : ''}`);
                
                // R√©initialiser le formulaire
                document.getElementById('govName').value = '';
                document.getElementById('govComment').value = '';
                governmentData.positions = [];
                renderPositions();
                document.getElementById('delegatesContainer').innerHTML = '';

            } catch (error) {
                console.error('‚ùå Erreur:', error);
                alert('Erreur inattendue : ' + error.message);
            }
        };

        // Fermer autocomplete au clic ailleurs
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.bloc-gouv-loupe') && !e.target.closest('.search-wrapper')) {
                document.querySelectorAll('.autocomplete-results').forEach(div => {
                    div.classList.remove('show');
                });
            }
        });

        // Initialisation
        async function init() {
            await loadPersonalities();
            renderPositions();
        }

        // Initialisation AVEC D√âLAI pour le router
        setTimeout(() => {
            init();
        }, 200);
    </script>
</body>
</html>